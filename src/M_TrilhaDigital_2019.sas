
%include '/dados/infor/suporte/FuncoesInfor.sas';

%LET NomeRelatorio=;
%LET NomePasta=;


LIBNAME DB2ITR      db2 AUTHDOMAIN=DB2SGCEN 	schema=DB2ITR 	database=BDB2P04;  
LIBNAME DB2ATB      db2 AUTHDOMAIN=DB2SGCEN 	schema=DB2ATB 	database=BDB2P04;  
LIBNAME DB2ARH      db2 AUTHDOMAIN=DB2SGCEN 	schema=DB2ARH 	database=BDB2P04;  
LIBNAME DB2GTD      db2 AUTHDOMAIN=DB2SGCEN 	schema=DB2GTD 	database=BDB2P04;  
LIBNAME DB2MCI      db2 AUTHDOMAIN=DB2SGCEN 	schema=DB2MCI 	database=BDB2P04;  


LIBNAME ADE '/dados/infor/producao/Aderencia';


DATA _NULL_;
    
	DATA_INICIO = '01JAN2018'd;
	DATA_FIM = '31DEC2019'd;
	DATA_REFERENCIA = diaUtilAnterior(TODAY());
	D1 = diaUtilAnterior(TODAY());
	D2 = diaUtilAnterior(D1);
	D3 = diaUtilAnterior(D2);
	MES_ATU = IFN((D1 <= DATA_FIM), Put(D1, yymmn6.), Put(DATA_FIM, yymmn6.));
	MES_ANT = Put(INTNX('month',primeiroDiaUtilMes(D1),-1), yymmn6.) ;
	MES_G = Put(DATA_REFERENCIA, MONTH.) ;
	ANOMES = IFN((D1 <= DATA_FIM), Put(D1, yymmn6.), Put(DATA_FIM, yymmn6.));
	DT_INICIO_SQL="'"||put(DATA_INICIO, YYMMDDD10.)||"'";
	DT_D1_SQL="'"||put(D1, YYMMDDD10.)||"'";
	DT_1DIA_MES_SQL="'"||put(primeiroDiaUtilMes(D1), YYMMDDD10.)||"'";
	DT_ANOMES_SQL=primeiroDiaUtilMes(D1);
	PRIMEIRO_DIA_MES_SQL="'"||put(primeiroDiaMes(DATA_REFERENCIA), YYMMDDD10.)||"'";
	

	CALL SYMPUT('DATA_HOJE',COMPRESS(TODAY(),' '));
	CALL SYMPUT('DT_1DIA_MES',COMPRESS(primeiroDiaUtilMes(D1),' '));
	CALL SYMPUT('DATA_INICIO',COMPRESS(DATA_INICIO,' '));
	CALL SYMPUT('DATA_FIM',COMPRESS(DATA_FIM,' '));
	CALL SYMPUT('D1',COMPRESS(D1,' '));
	CALL SYMPUT('D2',COMPRESS(D2,' '));
	CALL SYMPUT('D3',COMPRESS(D3,' '));
	CALL SYMPUT('MES_ATU',COMPRESS(MES_ATU,' '));
	CALL SYMPUT('MES_ANT',COMPRESS(MES_ANT,' '));
	CALL SYMPUT('ANOMES',COMPRESS(ANOMES,' '));
	CALL SYMPUT('RF',COMPRESS(ANOMES,' '));
	CALL SYMPUT('DT_ARQUIVO',put(DATA_REFERENCIA, DDMMYY10.));
	CALL SYMPUT('DT_ARQUIVO_SQL',put(DATA_REFERENCIA, YYMMDDD10.));
	CALL SYMPUT('DT_INICIO_SQL', COMPRESS(DT_INICIO_SQL,' '));
	CALL SYMPUT('DT_1DIA_MES_SQL', COMPRESS(DT_1DIA_MES_SQL,' '));
	CALL SYMPUT('DT_D1_SQL', COMPRESS(DT_D1_SQL,' '));
	CALL SYMPUT('DT_ANOMES_SQL', COMPRESS(DT_ANOMES_SQL,' '));
	CALL SYMPUT('MES_G', COMPRESS(MES_G,' '));
	CALL SYMPUT('PRIMEIRO_DIA_MES_SQL', COMPRESS(PRIMEIRO_DIA_MES_SQL,' '));
	CALL SYMPUT('DT_FIXA_SQL', COMPRESS(DT_FIXA_SQL,' '));

RUN;
 

PROC SQL;
	CREATE TABLE FUNCI AS 
		SELECT 
			t1.MATRICULA_215 AS MATRICULA, 
			t1.dep_lotacao_215 as PREFIXO,
			t1.nome_215 as NM_FUNCI,
			situacao_215,
			codigo_mci_215 AS MCI
		FROM ADE.ARH215_CADASTRO_BASICO_&anomes t1
			where dt_posicao=&d1. and  situacao_215 not in (150,3003,590,600,601,603,604,610,800,802,803,804,805,809,810,817,818,819,820,821,822,823,824,825,826,827,828,830,831,834,835,850,852,990);
QUIT;


/*TOTAL DE CURSOS*/
/*TOTAL DE CURSOS*/


PROC SQL;
   CREATE TABLE CURSOS_TOTAL AS 
   SELECT 
          MAX(DT_FIM_CSO) FORMAT=DateMysql. AS POSICAO,
		  t2.PREFIXO,
          t2.MATRICULA,
          t2.NM_FUNCI, 
          t1.CD_CSO AS CD_CURSO, 
          t1.DT_FIM_CSO AS DT_CONCLUSAO

      FROM DB2GTD.CSO_PSS_ITSE_SIS t1
INNER JOIN FUNCI T2 ON (T1.CD_PSS=T2.MCI)
WHERE t2.MATRICULA ne . AND dt_fim_cso >= '01jan2019'd AND t2.PREFIXO = 8592
;
QUIT;


/*TRILHA DIGITAL*/
/*TRILHA DIGITAL*/


PROC SQL;
   CREATE TABLE CURSOS_TRILHA_DIGITAL AS 
   SELECT 
          MAX(DT_FIM_CSO) FORMAT=DateMysql. AS POSICAO,
		  t2.PREFIXO,
          t2.MATRICULA,
          t2.NM_FUNCI, 
          t1.CD_CSO AS CD_CURSO, 
          t1.DT_FIM_CSO AS DT_CONCLUSAO

      FROM DB2GTD.CSO_PSS_ITSE_SIS t1
INNER JOIN FUNCI T2 ON (T1.CD_PSS=T2.MCI)
WHERE t2.MATRICULA ne . AND dt_fim_cso >= '01jan2019'd AND t2.PREFIXO = 8592

AND CD_CSO IN ( 
3780
4837
5354
5424
5426
5453
5584
5690
6829
6849
6851
6883
6943
6944
6945
6946
6949
6971
6992
6993
6994
6995
6996
6997
6998
6999
7000
7001
7099
7103
7104
7105
7106
7107
7110
7111
7112
7113
7114
7115
7116
7118
7125
7129
7130)
;
QUIT;

