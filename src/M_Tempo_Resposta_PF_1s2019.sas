

%INCLUDE '/dados/infor/suporte/FuncoesInfor.sas';

%LET Tx_Fon=6162;

LIBNAME DB2BIC DB2 DATABASE=BDB2P04 SCHEMA=DB2BIC AUTHDOMAIN=DB2SVARC;
LIBNAME DB2GAT DB2 DATABASE=BDB2P04 SCHEMA=DB2GAT AUTHDOMAIN=DB2SGCEN;
LIBNAME DB2CAF DB2 DATABASE=BDB2P04 SCHEMA=DB2CAF AUTHDOMAIN=DB2SGCEN;
LIBNAME DB2ATB DB2 DATABASE=BDB2P04 SCHEMA=DB2ATB AUTHDOMAIN=DB2SGCEN;
LIBNAME DB2ARG DB2 DATABASE=BDB2P04 SCHEMA=DB2ARG AUTHDOMAIN=DB2SGCEN;
LIBNAME DB2REL DB2 DATABASE=BDB2P04 SCHEMA=DB2REL AUTHDOMAIN=DB2SGCEN;

LIBNAME AUX "/dados/infor/producao/Tempo_Resposta_PF_PJ";
LIBNAME TEL "/dados/externo/UNC/GAT/TELEFONE";

DATA _NULL_;

/*D1 = '01JAN2019'd*/	
D1 = diaUtilAnterior(TODAY());
CALL SYMPUT('D1',COMPRESS(D1,' '));

/*ANOMES = 201901*/
ANOMES = Put(D1, yymmn6.);
CALL SYMPUT('ANOMES',COMPRESS(ANOMES,' '));

/*MESANO = 012019*/
MESANO=PUT(D1,mmyyn6.);
CALL SYMPUT('MESANO', COMPRESS(MESANO,' '));

/*ANO_ATUAL = 2019*/
ANO_ATUAL = 2019;
CALL SYMPUT('ANO_ATUAL',COMPRESS(ANO_ATUAL,' '));

/*MES_POSICAO = 01*/
MES_POSICAO = Put(MONTH (diaUtilAnterior(TODAY())), Z2.);
CALL SYMPUT('MES_POSICAO', COMPRESS(MES_POSICAO,' '));

call symput('INICIO',"'"||put ((intnx('month',d1, 0, 'begin')), FINDFDD10.)||"'");

RUN;

%Put &D1 &ANOMES &MESANO &ANO_ATUAL &MES_POSICAO &inicio;


/*************************************************/
/*****************PROCESSANDO*********************/
/*****************PROCESSANDO*********************/
/*************************************************/

/************************************************/
/*******************ACORDO***********************/
/*******************ACORDO***********************/
/************************************************/


PROC SQL;
CREATE TABLE ACORDO_CARTEIRA AS 
SELECT DISTINCT cd_uor_ctra AS UOR, nr_seql_ctra as CTRA
FROM DB2ATB.vl_aprd_in_ctra
where aa_vl_aprd_in = 2019 and mm_vl_aprd_in = MONTH(&D1.) and  cd_in_mod_avlc = 11953;
QUIT;


PROC SQL;
CREATE TABLE ACORDO_CARTEIRA_1 AS 
SELECT DISTINCT t1.UOR, CTRA, input(t2.PREFDEP, 4.) AS PREFIXO
FROM ACORDO_CARTEIRA t1
INNER JOIN IGR.IGRREDE_&ANOMES. t2 ON t1.UOR = input(t2.UOR, 9.);
QUIT;


PROC SQL;
CREATE TABLE ACORDO_PREFIXO AS 
SELECT DISTINCT cd_uor AS UOR, 0 as CTRA
FROM DB2ATB.vl_aprd_in_uor
where aa_vl_aprd_in = 2019 and mm_vl_aprd_in = MONTH(&D1.) and cd_In_mod_avlc = 11952;
QUIT;


PROC SQL;
CREATE TABLE ACORDO_PREFIXO_1 AS 
SELECT DISTINCT t1.UOR, CTRA, input(t2.PREFDEP, 4.) AS PREFIXO
FROM ACORDO_PREFIXO t1
INNER JOIN IGR.IGRREDE_&ANOMES. t2 ON t1.UOR = input(t2.UOR, 9.);
QUIT;


PROC SQL;

CREATE TABLE ACORDO AS
 
   SELECT * FROM ACORDO_CARTEIRA_1
   OUTER UNION CORR
   SELECT * FROM ACORDO_PREFIXO_1;

Quit;


PROC SQL;
CREATE TABLE ACORDO_1 AS 
SELECT DISTINCT PREFIXO, t1.CTRA, t1.UOR
FROM ACORDO t1
order by 1,2;
QUIT;



/**************************************************/
/**************************************************/
/*********************DEPENDENCIAS*****************/
/**************************************************/
/**************************************************/


PROC SQL;

   CREATE TABLE DEPENDENCIAS AS SELECT 

   INPUT(t1.PrefDep, d4.) as PREFIXO, 
   INPUT(t1.TipoDep, d3.) as TIPO_DEPENDENCIA,
   INPUT(t1.UOR, d9.) as UOR,
   t1.CD_GR_DEPE_FXO as CD_AGRUPAMENTO_FIXO,

   INPUT(t1.PREFSUPREG, d4.) as gerev,
   INPUT(t1.PREFSUPEST, d4.) as super,
   INPUT(t1.PREFUEN, d4.) as diretoria_jurisdicionante, 
   8592 as divar,
   8166 as vice_presidencia

   FROM IGR.IGRREDE_&ANOMES. t1
   inner join ACORDO_PREFIXO_1 t2 on INPUT(t1.PrefDep, d4.) = t2.prefixo
   ; 

QUIT;



PROC SQL;

   CREATE TABLE CLIENTES AS SELECT
          DISTINCT t1.CD_CLI AS MCI,

          t1.CD_PRF_DEPE AS PREFIXO, 
          t1.NR_SEQL_CTRA_ATB AS CARTEIRA, 
          t1.CD_TIP_CTRA AS TIPO_CARTEIRA,
		  t2.TIPO_DEPENDENCIA,          
          t2.CD_AGRUPAMENTO_FIXO,
		  t2.UOR          
		   	  
      FROM COMUM.PAI_REL_&ANOMES. t1
      INNER JOIN DEPENDENCIAS t2 ON (t1.CD_PRF_DEPE = t2.PREFIXO)
	  INNER JOIN ACORDO_CARTEIRA_1 t3 ON t1.CD_PRF_DEPE = t3.PREFIXO AND t1.NR_SEQL_CTRA_ATB = t3.CTRA
      ;

QUIT;



/*******FERIADOS NACIONAIS*******/
/*******FERIADOS NACIONAIS*******/
/*******FERIADOS NACIONAIS*******/
/*******FERIADOS NACIONAIS*******/


PROC SQL;

     CREATE TABLE PREFIXO_FERIADO AS SELECT DISTINCT
           
	      t1.PREFIXO		  
		  
      FROM CLIENTES t1;

QUIT;


Data TAB_1;
format DT_FER yymmdd10.;
set PREFIXO_FERIADO;
DT_FER = '04MAR2019'd;
IND_FERIADO = 1;
run;


Data TAB_2;
format DT_FER yymmdd10.;
set PREFIXO_FERIADO;
DT_FER = '05MAR2019'd;
IND_FERIADO = 1;
run;


Data TAB_3;
format DT_FER yymmdd10.;
set PREFIXO_FERIADO;
DT_FER = '19APR2019'd;
IND_FERIADO = 1;
run;


Data TAB_4;
format DT_FER yymmdd10.;
set PREFIXO_FERIADO;
DT_FER = '01MAY2019'd;
IND_FERIADO = 1;
run;


Data TAB_5;
format DT_FER yymmdd10.;
set PREFIXO_FERIADO;
DT_FER = '20JUN2019'd;
IND_FERIADO = 1;
run;


Data TAB_6;
format DT_FER yymmdd10.;
set PREFIXO_FERIADO;
DT_FER = '25DEC2018'd;
IND_FERIADO = 1;
run;


Data TAB_7;
format DT_FER yymmdd10.;
set PREFIXO_FERIADO;
DT_FER = '01JAN2019'd;
IND_FERIADO = 1;
run;


PROC SQL;

CREATE TABLE PREFIXO_FERIADO_ANT AS
 
   SELECT * FROM TAB_1
   OUTER UNION CORR
   SELECT * FROM TAB_2
   OUTER UNION CORR
   SELECT * FROM TAB_3
   OUTER UNION CORR
   SELECT * FROM TAB_4
   OUTER UNION CORR
   SELECT * FROM TAB_5
   OUTER UNION CORR
   SELECT * FROM TAB_6
   OUTER UNION CORR
   SELECT * FROM TAB_7;

Quit;


PROC SQL;

CREATE TABLE PREFIXO_FERIADO_ANT AS SELECT *

    FROM PREFIXO_FERIADO_ANT

ORDER BY 2;

Quit;


/********FERIADOS DO CAF*********/
/********FERIADOS DO CAF*********/

/*
PROC SQL;

CREATE TABLE PREF_FER_EST_MUN AS SELECT 

    t1.AGENCIA AS PREFIXO,
	INPUT(TRIM(PUT(t1.FERIADO, 8.)),YYMMDD10.) FORMAT yymmdd10. AS DT_FER,
	1 AS IND_FERIADO
 
    FROM DB2CAF.TCAF615 t1;

Quit;*/

PROC SQL;
	CREATE TABLE WORK.PREF_FER_EST_MUN AS 
		SELECT 
			input (t2.prefdep, 4.) as PREFIXO,
			t1.DT_FRDO FORMAT yymmdd10. AS DT_FER,
			1 as ind_feriado
		FROM DB2ARG.FRDO_MUN t1
			inner join igr.dependencias t2 on (put (t1.CD_MUN,z5.) = t2.CidBB)
				where sb='00' and year (t1.DT_FRDO) = 2019
					order by 1;
QUIT;



 

PROC SQL;

CREATE TABLE PREFIXO_FERIADO_1 AS
 
   SELECT t1.PREFIXO, t1.DT_FER, t1.IND_FERIADO FROM PREFIXO_FERIADO_ANT t1
   UNION 
   SELECT t2.PREFIXO, t2.DT_FER, t2.IND_FERIADO FROM PREF_FER_EST_MUN t2 ;

Quit;



/*******FALE COM*******/
/*******FALE COM*******/
/*******FALE COM*******/
/*******FALE COM*******/

/*MES CORRENTE*/

PROC SQL;

   CREATE TABLE BASE_FALECOM_BIC_PF AS SELECT DISTINCT 

      t1.CD_CLI AS MCI,
	  t1.TS_INRO_CLI AS TS,
	  t1.DT_INCL_REG_INRO AS DATA,
	  t1.TX_PTL_INRO_CLI AS PTL,
	  t1.CD_TRAN_INRO_SIS,
	  t1.CD_PRF_DEPE_CLI
		  
      FROM DB2BIC.AUX_INRO_CLI_ATU t1
	  LEFT JOIN DB2BIC.BNFC_INRO t2 ON (t1.CD_CLI = t2.CD_CLI AND t1.TS_INRO_CLI = t2.TS_INRO_CLI)
      WHERE t1.CD_TRAN_INRO_SIS IN ("MIV10014", "MIV10016", "MIV10017")AND
		t1.CD_TIP_PSS = 1 AND
		(t1.CD_CLI = t2.CD_CLI_BNFC_INRO OR t2.CD_CLI_BNFC_INRO IS MISSING);

QUIT;


/*ABERTURAS DO MES ANTERIOR*/

PROC SQL;

   CREATE TABLE BASE_FALECOM_BIC_PF_ANTERIOR AS SELECT DISTINCT 

      t1.CD_CLI AS MCI,
	  t1.TS_INRO_CLI AS TS,
	  t1.DT_INCL_REG_INRO AS DATA,
	  t1.TX_PTL_INRO_CLI AS PTL,
	  t1.CD_TRAN_INRO_SIS,
	  t1.CD_PRF_DEPE_CLI
		  
      FROM DB2BIC.AUX_INRO_CLI_ANT t1 LEFT JOIN DB2BIC.BNFC_INRO t2 ON (t1.CD_CLI = t2.CD_CLI AND t1.TS_INRO_CLI = t2.TS_INRO_CLI)
      WHERE t1.CD_TRAN_INRO_SIS IN ("MIV10014", "MIV10016", "MIV10017")AND
		t1.CD_TIP_PSS = 1 AND
		(t1.CD_CLI = t2.CD_CLI_BNFC_INRO OR t2.CD_CLI_BNFC_INRO IS MISSING);

QUIT;


PROC SQL;

   CREATE TABLE FALECOM_ABERTURA_CORRENTE AS SELECT DISTINCT

      t1.MCI AS MCI_ABERTURA,
	  t1.TS AS TS_ABERTURA,
	  t1.DATA AS DATA_ABERTURA,
	  t1.PTL AS PTL_ABERTURA,
	  t1.CD_PRF_DEPE_CLI
		  
      FROM BASE_FALECOM_BIC_PF t1
      WHERE CD_TRAN_INRO_SIS = "MIV10014" AND MONTH(t1.DATA) = &MES_POSICAO. AND YEAR(t1.DATA) = &ANO_ATUAL. AND t1.DATA <= &D1;

QUIT;


PROC SQL;

   CREATE TABLE FALECOM_ABERTURA_ANTERIOR_1 AS SELECT DISTINCT

      t1.MCI AS MCI_ABERTURA,
	  t1.TS AS TS_ABERTURA,
	  t1.DATA AS DATA_ABERTURA,
	  t1.PTL AS PTL_ABERTURA
		  
      FROM BASE_FALECOM_BIC_PF_ANTERIOR t1
      WHERE CD_TRAN_INRO_SIS = "MIV10014" AND MONTH(t1.DATA) = 12 AND YEAR(t1.DATA) = 2018;

QUIT;


PROC SQL;

CREATE TABLE FALECOM_ABERTURA AS 
   SELECT * FROM FALECOM_ABERTURA_CORRENTE
   OUTER UNION CORR
SELECT * FROM FALECOM_ABERTURA_ANTERIOR_1;

Quit;


PROC SQL;

   CREATE TABLE FALECOM_FECHAMENTO AS SELECT DISTINCT

      t1.MCI AS MCI_FECHAMENTO,
	  t1.TS AS TS_FECHAMENTO,
	  t1.DATA AS DATA_FECHAMENTO,
	  t1.PTL AS PTL_FECHAMENTO	  
		  
      FROM BASE_FALECOM_BIC_PF t1
      WHERE t1.CD_TRAN_INRO_SIS IN ('MIV10016', 'MIV10017') AND MONTH(t1.DATA) = &MES_POSICAO. AND YEAR(t1.DATA) = &ANO_ATUAL. AND t1.DATA <= &D1;

QUIT;


PROC SQL;

   CREATE TABLE FALECOM_FECHAMENTO_2 AS SELECT DISTINCT

      t1.MCI_FECHAMENTO,
	  t1.TS_FECHAMENTO,
	  t1.DATA_FECHAMENTO,
	  t1.PTL_FECHAMENTO
		  
      FROM FALECOM_FECHAMENTO t1
	  GROUP BY 4
      HAVING MIN(t1.TS_FECHAMENTO) = t1.TS_FECHAMENTO;

QUIT;


PROC SQL;

      CREATE TABLE FALECOM_1 AS SELECT 

	  t1.MCI_ABERTURA AS MCI,
	  t1.TS_ABERTURA,
	  t2.TS_FECHAMENTO,
      TIMEPART(t1.TS_ABERTURA) FORMAT=TIME8. AS HMS_Abertura,
	  TIMEPART(t2.TS_FECHAMENTO) FORMAT=TIME8. AS HMS_Fechamento,
	  t1.DATA_ABERTURA,
	  t2.DATA_FECHAMENTO,
	  WEEKDAY(t1.DATA_ABERTURA) AS D_SEM_ABERTURA,
	  WEEKDAY(t2.DATA_FECHAMENTO) AS D_SEM_FECHAMENTO,
	  t1.PTL_ABERTURA AS PTL,
	  t1.CD_PRF_DEPE_CLI
		  
      FROM FALECOM_ABERTURA t1
      INNER JOIN FALECOM_FECHAMENTO_2 t2 ON (t1.MCI_ABERTURA = t2.MCI_FECHAMENTO AND t1.PTL_ABERTURA = t2.PTL_FECHAMENTO);      

QUIT;


/********ENCARTEIRANDO*********/
/********ENCARTEIRANDO*********/
/********ENCARTEIRANDO*********/
/********ENCARTEIRANDO*********/


PROC SQL;

      CREATE TABLE FALECOM_2 AS SELECT DISTINCT
      
	  t2.PREFIXO,
	  t2.CARTEIRA,
	  t1.PTL,
	  t1.MCI,
	  t1.TS_ABERTURA,
	  t1.TS_FECHAMENTO,
      t1.HMS_Abertura,
	  t1.HMS_Fechamento,
	  t1.DATA_ABERTURA FORMAT yymmdd10.,
	  t1.DATA_FECHAMENTO FORMAT yymmdd10.,
	  t1.D_SEM_ABERTURA,
	  t1.D_SEM_FECHAMENTO
		  
      FROM FALECOM_1 t1
      INNER JOIN CLIENTES t2 ON (t1.MCI = t2.MCI)
      ;      

QUIT;


PROC STDIZE DATA=FALECOM_2 OUT=FALECOM_2 REPONLY MISSING=0;
	VAR _NUMERIC_;
QUIT;


/********TRATAMENTO FERIADO*********/
/********TRATAMENTO FERIADO*********/
/********TRATAMENTO FERIADO*********/
/********TRATAMENTO FERIADO*********/


/*********APLICANDO CORRECAO SAB E DOM**********/
/*********APLICANDO CORRECAO SAB E DOM**********/


PROC SQL;

   CREATE TABLE FALECOM_3 AS SELECT DISTINCT

      t1.PREFIXO,
	  t1.CARTEIRA,
	  t1.PTL,
	  t1.MCI,
	  t1.TS_ABERTURA,
	  t1.TS_FECHAMENTO,
      t1.HMS_ABERTURA,
	  t1.HMS_FECHAMENTO,
	  t1.DATA_ABERTURA,
	  t1.DATA_FECHAMENTO,
	  t1.D_SEM_ABERTURA,
	  t1.D_SEM_FECHAMENTO,

      IFN(t1.D_SEM_ABERTURA NOT IN (1,7), IFN(HOUR(t1.HMS_ABERTURA) > 17, IFN(t1.D_SEM_ABERTURA IN (2,3,4,5), t1.DATA_ABERTURA + 1, t1.DATA_ABERTURA + 3)
      , t1.DATA_ABERTURA), IFN(t1.D_SEM_ABERTURA IN (1), t1.DATA_ABERTURA + 1, t1.DATA_ABERTURA + 2)) FORMAT yymmdd10. AS DATA_ABERTURA_NOVO_1,
	  

      IFN(t1.D_SEM_ABERTURA NOT IN (1,7), IFN(HOUR(t1.HMS_ABERTURA) < 8 OR HOUR(t1.HMS_ABERTURA) > 17, "8:0:0"t, t1.HMS_ABERTURA), "8:0:0"t) FORMAT=TIME8. AS HMS_ABERTURA_NOVO_1,
  
      IFN(t1.D_SEM_FECHAMENTO NOT IN (1,7), IFN(HOUR(t1.HMS_FECHAMENTO) > 17, IFN(t1.D_SEM_FECHAMENTO IN (2,3,4,5), t1.DATA_FECHAMENTO + 1, t1.DATA_FECHAMENTO + 3)
      , t1.DATA_FECHAMENTO), IFN(t1.D_SEM_FECHAMENTO IN (1), t1.DATA_FECHAMENTO + 1, t1.DATA_FECHAMENTO + 2)) FORMAT yymmdd10. AS DATA_FECHAMENTO_NOVO_1,


      IFN(t1.D_SEM_FECHAMENTO NOT IN (1,7), IFN(HOUR(t1.HMS_FECHAMENTO) < 8 OR HOUR(t1.HMS_FECHAMENTO) > 17, "8:0:0"t, t1.HMS_FECHAMENTO), "8:0:0"t) FORMAT=TIME8. AS HMS_FECHAMENTO_NOVO_1
             

   FROM FALECOM_2 t1;

QUIT;


/*********APLICANDO CORRECAO FERIADO**********/
/*********APLICANDO CORRECAO FERIADO**********/


PROC SQL;

      CREATE TABLE FALECOM_4 AS SELECT 
      
	  t1.PREFIXO,
	  t1.CARTEIRA,
	  t1.PTL,
	  t1.MCI,
	  t1.TS_ABERTURA,
	  t1.TS_FECHAMENTO,
      t1.HMS_Abertura,
	  t1.HMS_Fechamento,
	  t1.DATA_ABERTURA,
	  t1.DATA_FECHAMENTO,
	  t1.D_SEM_ABERTURA,
	  t1.D_SEM_FECHAMENTO,
	  t1.DATA_ABERTURA_NOVO_1,
	  t1.DATA_FECHAMENTO_NOVO_1,
	  t1.HMS_ABERTURA_NOVO_1,
	  t1.HMS_FECHAMENTO_NOVO_1,
	  t2.IND_FERIADO AS IND_FER_ABERT,
	  t3.IND_FERIADO AS IND_FER_FECH
	  
      FROM FALECOM_3 t1
      LEFT JOIN PREFIXO_FERIADO_1 t2 ON (t1.PREFIXO = t2.PREFIXO AND t1.DATA_ABERTURA_NOVO_1 = t2.DT_FER)
	  LEFT JOIN PREFIXO_FERIADO_1 t3 ON (t1.PREFIXO = t3.PREFIXO AND t1.DATA_FECHAMENTO_NOVO_1 = t3.DT_FER)
      GROUP BY 1,2,3;      

QUIT;


PROC STDIZE OUT=FALECOM_4 REPONLY MISSING=0;
	VAR _NUMERIC_;
QUIT;


PROC SQL;

      CREATE TABLE FALECOM_5 AS SELECT 
      
	  t1.PREFIXO,
	  t1.CARTEIRA,
	  t1.PTL,
	  t1.MCI,
	  t1.TS_ABERTURA,
	  t1.TS_FECHAMENTO,
      t1.HMS_ABERTURA,
	  t1.HMS_FECHAMENTO,
	  t1.DATA_ABERTURA,
	  t1.DATA_FECHAMENTO,
	  t1.D_SEM_ABERTURA,
	  t1.D_SEM_FECHAMENTO,
	  t1.DATA_ABERTURA_NOVO_1,
	  t1.DATA_FECHAMENTO_NOVO_1,
	  t1.HMS_ABERTURA_NOVO_1,
	  t1.HMS_FECHAMENTO_NOVO_1,
	  t1.IND_FER_ABERT,
	  t1.IND_FER_FECH,

      IFN(DATA_ABERTURA_NOVO_1 = '04JUL2019'd, DATA_ABERTURA_NOVO_1 + 2, 
      IFN(IND_FER_ABERT = 1, 
      IFN(WEEKDAY(DATA_ABERTURA_NOVO_1) = 6, DATA_ABERTURA_NOVO_1 + 3, 
      IFN(WEEKDAY(DATA_ABERTURA_NOVO_1) = 7, DATA_ABERTURA_NOVO_1 + 2, DATA_ABERTURA_NOVO_1 + 1)), DATA_ABERTURA_NOVO_1)) FORMAT yymmdd10. AS DATA_ABERTURA_NOVO_2,

      IFN(DATA_ABERTURA_NOVO_1 = '06MAR2019'd, "12:0:0"t, IFN(IND_FER_ABERT = 1, "8:0:0"t, HMS_ABERTURA_NOVO_1)) FORMAT = TIME8. AS HMS_ABERTURA_NOVO_2,
	  

      IFN(DATA_FECHAMENTO_NOVO_1 = '04JUL2019'd, DATA_FECHAMENTO_NOVO_1 + 2, 
      IFN(IND_FER_FECH = 1, 
      IFN(WEEKDAY(DATA_FECHAMENTO_NOVO_1) = 6, DATA_FECHAMENTO_NOVO_1 + 3, 
      IFN(WEEKDAY(DATA_FECHAMENTO_NOVO_1) = 7, DATA_FECHAMENTO_NOVO_1 + 2, DATA_FECHAMENTO_NOVO_1 + 1)), DATA_FECHAMENTO_NOVO_1)) FORMAT yymmdd10. AS DATA_FECHAMENTO_NOVO_2,

	  IFN(DATA_FECHAMENTO_NOVO_1 = '06MAR2019'd, "12:0:0"t, IFN(IND_FER_FECH = 1, "8:0:0"t, HMS_FECHAMENTO_NOVO_1)) FORMAT = TIME8. AS HMS_FECHAMENTO_NOVO_2
		  
      FROM FALECOM_4 t1;      

QUIT;


/*********APLICANDO CORRECAO FERIADO PELA SEGUNDA VEZ**********/
/*********APLICANDO CORRECAO FERIADO PELA SEGUNDA VEZ**********/


PROC SQL;

      CREATE TABLE FALECOM_6 AS SELECT 
      
	  t1.PREFIXO,
	  t1.CARTEIRA,
	  t1.PTL,
	  t1.MCI,
	  t1.TS_ABERTURA,
	  t1.TS_FECHAMENTO,
      t1.HMS_Abertura,
	  t1.HMS_Fechamento,
	  t1.DATA_ABERTURA,
	  t1.DATA_FECHAMENTO,
	  t1.D_SEM_ABERTURA,
	  t1.D_SEM_FECHAMENTO,
	  t1.DATA_ABERTURA_NOVO_1,
	  t1.DATA_FECHAMENTO_NOVO_1,
	  t1.HMS_ABERTURA_NOVO_1,
	  t1.HMS_FECHAMENTO_NOVO_1,
	  t1.DATA_ABERTURA_NOVO_2,
	  t1.DATA_FECHAMENTO_NOVO_2,
	  t1.HMS_ABERTURA_NOVO_2,
	  t1.HMS_FECHAMENTO_NOVO_2,
	  t2.IND_FERIADO AS IND_FER_ABERT,
	  t3.IND_FERIADO AS IND_FER_FECH
	  
      FROM FALECOM_5 t1
      LEFT JOIN PREFIXO_FERIADO_1 t2 ON (t1.PREFIXO = t2.PREFIXO AND t1.DATA_ABERTURA_NOVO_2 = t2.DT_FER)
	  LEFT JOIN PREFIXO_FERIADO_1 t3 ON (t1.PREFIXO = t3.PREFIXO AND t1.DATA_FECHAMENTO_NOVO_2 = t3.DT_FER)
      GROUP BY 1,2,3;      

QUIT;


PROC STDIZE OUT=FALECOM_6 REPONLY MISSING=0;
	VAR _NUMERIC_;
QUIT;


PROC SQL;

      CREATE TABLE FALECOM_7 AS SELECT 
      
	  t1.PREFIXO,
	  t1.CARTEIRA,
	  t1.PTL,
	  t1.MCI,
	  t1.TS_ABERTURA,
	  t1.TS_FECHAMENTO,
      t1.HMS_ABERTURA,
	  t1.HMS_FECHAMENTO,
	  t1.DATA_ABERTURA,
	  t1.DATA_FECHAMENTO,
	  t1.D_SEM_ABERTURA,
	  t1.D_SEM_FECHAMENTO,
	  t1.DATA_ABERTURA_NOVO_1,
	  t1.DATA_FECHAMENTO_NOVO_1,
	  t1.HMS_ABERTURA_NOVO_1,
	  t1.HMS_FECHAMENTO_NOVO_1,
	  t1.DATA_ABERTURA_NOVO_2,
	  t1.DATA_FECHAMENTO_NOVO_2,
	  t1.HMS_ABERTURA_NOVO_2,
	  t1.HMS_FECHAMENTO_NOVO_2,
	  t1.IND_FER_ABERT,
	  t1.IND_FER_FECH,

      IFN(DATA_ABERTURA_NOVO_2 = '04JUL2019'd, DATA_ABERTURA_NOVO_2 + 2, 
      IFN(IND_FER_ABERT = 1, 
      IFN(WEEKDAY(DATA_ABERTURA_NOVO_2) = 6, DATA_ABERTURA_NOVO_2 + 3, 
      IFN(WEEKDAY(DATA_ABERTURA_NOVO_2) = 7, DATA_ABERTURA_NOVO_2 + 2, DATA_ABERTURA_NOVO_2 + 1)), DATA_ABERTURA_NOVO_2)) FORMAT yymmdd10. AS DATA_ABERTURA_NOVO_3,

      IFN(DATA_ABERTURA_NOVO_2 = '06MAR2019'd, "12:0:0"t, IFN(IND_FER_ABERT = 1, "8:0:0"t, HMS_ABERTURA_NOVO_2)) FORMAT = TIME8. AS HMS_ABERTURA_NOVO_3,
	  
      IFN(DATA_FECHAMENTO_NOVO_2 = '04JUL2019'd, DATA_FECHAMENTO_NOVO_2 + 2, 
      IFN(IND_FER_FECH = 1, 
      IFN(WEEKDAY(DATA_FECHAMENTO_NOVO_2) = 6, DATA_FECHAMENTO_NOVO_2 + 3, 
      IFN(WEEKDAY(DATA_FECHAMENTO_NOVO_2) = 7, DATA_FECHAMENTO_NOVO_2 + 2, DATA_FECHAMENTO_NOVO_2 + 1)), DATA_FECHAMENTO_NOVO_2)) FORMAT yymmdd10. AS DATA_FECHAMENTO_NOVO_3,

	  IFN(DATA_FECHAMENTO_NOVO_2 = '06MAR2019'd, "12:0:0"t, IFN(IND_FER_FECH = 1, "8:0:0"t, HMS_FECHAMENTO_NOVO_2)) FORMAT = TIME8. AS HMS_FECHAMENTO_NOVO_3
		  
      FROM FALECOM_6 t1;      

QUIT;



/*********APLICANDO CORRECAO FERIADO PELA TERCEIRA VEZ**********/
/*********APLICANDO CORRECAO FERIADO PELA TERCEIRA VEZ**********/


PROC SQL;

      CREATE TABLE FALECOM_8 AS SELECT 
      
	  t1.PREFIXO,
	  t1.CARTEIRA,
	  t1.PTL,
	  t1.MCI,
	  t1.TS_ABERTURA,
	  t1.TS_FECHAMENTO,
      t1.HMS_Abertura,
	  t1.HMS_Fechamento,
	  t1.DATA_ABERTURA,
	  t1.DATA_FECHAMENTO,
	  t1.D_SEM_ABERTURA,
	  t1.D_SEM_FECHAMENTO,
	  t1.DATA_ABERTURA_NOVO_1,
	  t1.DATA_FECHAMENTO_NOVO_1,
	  t1.HMS_ABERTURA_NOVO_1,
	  t1.HMS_FECHAMENTO_NOVO_1,
	  t1.DATA_ABERTURA_NOVO_2,
	  t1.DATA_FECHAMENTO_NOVO_2,
	  t1.HMS_ABERTURA_NOVO_2,
	  t1.HMS_FECHAMENTO_NOVO_2,
	  t1.DATA_ABERTURA_NOVO_3,
	  t1.DATA_FECHAMENTO_NOVO_3,
	  t1.HMS_ABERTURA_NOVO_3,
	  t1.HMS_FECHAMENTO_NOVO_3,
	  t2.IND_FERIADO AS IND_FER_ABERT,
	  t3.IND_FERIADO AS IND_FER_FECH
	  
      FROM FALECOM_7 t1
      LEFT JOIN PREFIXO_FERIADO_1 t2 ON (t1.PREFIXO = t2.PREFIXO AND t1.DATA_ABERTURA_NOVO_3 = t2.DT_FER)
	  LEFT JOIN PREFIXO_FERIADO_1 t3 ON (t1.PREFIXO = t3.PREFIXO AND t1.DATA_FECHAMENTO_NOVO_3 = t3.DT_FER)
      GROUP BY 1,2,3;      

QUIT;


PROC STDIZE OUT=FALECOM_8 REPONLY MISSING=0;
	VAR _NUMERIC_;
QUIT;


PROC SQL;

      CREATE TABLE FALECOM_9 AS SELECT 
      
	  t1.PREFIXO,
	  t1.CARTEIRA,
	  t1.PTL,
	  t1.MCI,
	  t1.TS_ABERTURA,
	  t1.TS_FECHAMENTO,
      t1.HMS_ABERTURA,
	  t1.HMS_FECHAMENTO,
	  t1.DATA_ABERTURA,
	  t1.DATA_FECHAMENTO,
	  t1.D_SEM_ABERTURA,
	  t1.D_SEM_FECHAMENTO,
	  t1.DATA_ABERTURA_NOVO_1,
	  t1.DATA_FECHAMENTO_NOVO_1,
	  t1.HMS_ABERTURA_NOVO_1,
	  t1.HMS_FECHAMENTO_NOVO_1,
	  t1.DATA_ABERTURA_NOVO_2,
	  t1.DATA_FECHAMENTO_NOVO_2,
	  t1.HMS_ABERTURA_NOVO_2,
	  t1.HMS_FECHAMENTO_NOVO_2,
	  t1.DATA_ABERTURA_NOVO_3,
	  t1.DATA_FECHAMENTO_NOVO_3,
	  t1.HMS_ABERTURA_NOVO_3,
	  t1.HMS_FECHAMENTO_NOVO_3,
	  t1.IND_FER_ABERT,
	  t1.IND_FER_FECH,

      IFN(DATA_ABERTURA_NOVO_3 = '04JUL2019'd, DATA_ABERTURA_NOVO_3 + 2, 
      IFN(IND_FER_ABERT = 1, 
      IFN(WEEKDAY(DATA_ABERTURA_NOVO_3) = 6, DATA_ABERTURA_NOVO_3 + 3, 
      IFN(WEEKDAY(DATA_ABERTURA_NOVO_3) = 7, DATA_ABERTURA_NOVO_3 + 2, DATA_ABERTURA_NOVO_3 + 1)), DATA_ABERTURA_NOVO_3)) FORMAT yymmdd10. AS DATA_ABERTURA_NOVO_ULT,

      IFN(DATA_ABERTURA_NOVO_3 = '06MAR2019'd, "12:0:0"t, IFN(IND_FER_ABERT = 1, "8:0:0"t, HMS_ABERTURA_NOVO_3)) FORMAT = TIME8. AS HMS_ABERTURA_NOVO_ULT,
	  
      IFN(DATA_FECHAMENTO_NOVO_3 = '04JUL2019'd, DATA_FECHAMENTO_NOVO_3 + 2, 
      IFN(IND_FER_FECH = 1, 
      IFN(WEEKDAY(DATA_FECHAMENTO_NOVO_3) = 6, DATA_FECHAMENTO_NOVO_3 + 3, 
      IFN(WEEKDAY(DATA_FECHAMENTO_NOVO_3) = 7, DATA_FECHAMENTO_NOVO_3 + 2, DATA_FECHAMENTO_NOVO_3 + 1)), DATA_FECHAMENTO_NOVO_3)) FORMAT yymmdd10. AS DATA_FECHAMENTO_NOVO_ULT,

	  IFN(DATA_FECHAMENTO_NOVO_3 = '06MAR2019'd, "12:0:0"t, IFN(IND_FER_FECH = 1, "8:0:0"t, HMS_FECHAMENTO_NOVO_3)) FORMAT = TIME8. AS HMS_FECHAMENTO_NOVO_ULT
		  
      FROM FALECOM_8 t1;      

QUIT;


/********CALCULO TEMPO*********/
/********CALCULO TEMPO*********/
/********CALCULO TEMPO*********/
/********CALCULO TEMPO*********/


PROC SQL;

   CREATE TABLE FALECOM_10 AS SELECT DISTINCT

      t1.PREFIXO,
	  t1.CARTEIRA,
	  t1.PTL,
	  t1.MCI,
	  t1.DATA_ABERTURA,
	  t1.DATA_FECHAMENTO,
	  t1.HMS_ABERTURA,
	  t1.HMS_FECHAMENTO,
	  t1.DATA_ABERTURA_NOVO_ULT,
	  t1.DATA_FECHAMENTO_NOVO_ULT,
	  t1.HMS_ABERTURA_NOVO_ULT,
	  t1.HMS_FECHAMENTO_NOVO_ULT,

      (t1.DATA_FECHAMENTO_NOVO_ULT - t1.DATA_ABERTURA_NOVO_ULT) AS DIF_TEMP_1,
	  (t1.HMS_FECHAMENTO_NOVO_ULT - t1.HMS_ABERTURA_NOVO_ULT) FORMAT = TIME8. AS DIF_TEMP_2 

	      
      FROM FALECOM_9 t1;

QUIT;


/***AJUSTANDO A DIFERENCA DE DIAS***/
/***AJUSTANDO A DIFERENCA DE DIAS***/
/***AJUSTANDO A DIFERENCA DE DIAS***/
/***AJUSTANDO A DIFERENCA DE DIAS***/

DATA AUXILIAR_SABDOM;
 
        INPUT  CHAVE 2.
              SD date9.;
CARDS;
1 01DEC2018
1 02DEC2018
1 08DEC2018
1 09DEC2018
1 15DEC2018
1 16DEC2018
1 22DEC2018
1 23DEC2018
1 29DEC2018
1 30DEC2018
1 05JAN2019
1 06JAN2019
1 12JAN2019
1 13JAN2019
1 19JAN2019
1 20JAN2019
1 26JAN2019
1 27JAN2019
1 02FEB2019
1 03FEB2019
1 09FEB2019
1 10FEB2019
1 16FEB2019
1 17FEB2019
1 23FEB2019
1 24FEB2019
1 02MAR2019
1 03MAR2019
1 09MAR2019
1 10MAR2019
1 16MAR2019
1 17MAR2019
1 23MAR2019
1 24MAR2019
1 30MAR2019
1 31MAR2019
1 06APR2019
1 07APR2019
1 13APR2019
1 14APR2019
1 20APR2019
1 21APR2019
1 27APR2019
1 28APR2019
1 04MAY2019
1 05MAY2019
1 11MAY2019
1 12MAY2019
1 18MAY2019
1 19MAY2019
1 25MAY2019
1 26MAY2019
1 01JUN2019
1 02JUN2019
1 08JUN2019
1 09JUN2019
1 15JUN2019
1 16JUN2019
1 22JUN2019
1 23JUN2019
1 29JUN2019
1 30JUN2019
;

run;


PROC SQL;

   CREATE TABLE AUXILIAR_SABDOM_2 AS SELECT DISTINCT

      CHAVE,
      SD format yymmdd10. AS DT_FER
	  	      
   FROM AUXILIAR_SABDOM t1;

QUIT;


PROC SQL;

     CREATE TABLE LISTA_PREFIXOS AS SELECT DISTINCT
           
	      t1.PREFIXO		  
		  
      FROM CLIENTES t1;

QUIT;


Data LISTA_PREFIXOS_1;
SET PREFIXO_FERIADO;
IND_FERIADO = 1;
run;


PROC SQL;

   CREATE TABLE JUNTANDO AS SELECT DISTINCT

     t1.PREFIXO,
	 t2.DT_FER	 
	  	      
   FROM LISTA_PREFIXOS_1 t1
   INNER JOIN AUXILIAR_SABDOM_2 t2 ON t1.IND_FERIADO = t2.CHAVE
   ORDER BY 1;

QUIT;


/********/

PROC SQL;

CREATE TABLE PREFIXO_FERIADO_2 AS SELECT 

   t1.PREFIXO,
   t1.DT_FER

FROM PREFIXO_FERIADO_1 t1
ORDER BY 2;

Quit;


PROC SQL;

CREATE TABLE JUNTANDO_FINAL AS
 
   SELECT t1.PREFIXO, t1.DT_FER FROM JUNTANDO t1
   UNION 
   SELECT t2.PREFIXO, t2.DT_FER FROM PREFIXO_FERIADO_2 t2;

Quit;


/***TIRAMOS OS FERIADOS DA CONTAGEM DE DIAS***/
/***TIRAMOS OS FERIADOS DA CONTAGEM DE DIAS***/

PROC SQL;

   CREATE TABLE FALECOM_CORRECAO AS SELECT DISTINCT

      t1.PREFIXO, t2.DT_FER, t1.DATA_ABERTURA_NOVO_ULT, t1.DATA_FECHAMENTO_NOVO_ULT
	  	      
      FROM FALECOM_10 t1
      INNER JOIN JUNTANDO_FINAL t2 ON t1.PREFIXO = t2.PREFIXO
      WHERE DT_FER > t1.DATA_ABERTURA_NOVO_ULT AND DT_FER < t1.DATA_FECHAMENTO_NOVO_ULT;

QUIT;


PROC SQL;

   CREATE TABLE FALECOM_CORRECAO_2 AS SELECT DISTINCT

      t1.PREFIXO, t1.DATA_ABERTURA_NOVO_ULT, t1.DATA_FECHAMENTO_NOVO_ULT, COUNT(DT_FER) AS CONTAGEM
	  	      
   FROM FALECOM_CORRECAO t1
   GROUP BY 1, 2, 3;

QUIT;


PROC SQL;

   CREATE TABLE FALECOM_CORRECAO_3 AS SELECT DISTINCT

      t1.PREFIXO,
	  t1.CARTEIRA,
	  t1.PTL,
	  t1.MCI,
	  t1.DATA_ABERTURA,
	  t1.DATA_FECHAMENTO,
	  t1.HMS_ABERTURA,
	  t1.HMS_FECHAMENTO,
	  t1.DATA_ABERTURA_NOVO_ULT,
	  t1.DATA_FECHAMENTO_NOVO_ULT,
	  t1.HMS_ABERTURA_NOVO_ULT,
	  t1.HMS_FECHAMENTO_NOVO_ULT, 
      t1.DIF_TEMP_1, 
      t1.DIF_TEMP_2,  
      t2.CONTAGEM 
	      
      FROM FALECOM_10 t1

   LEFT JOIN FALECOM_CORRECAO_2 t2 ON t1.PREFIXO = t2.PREFIXO AND t1.DATA_ABERTURA_NOVO_ULT = t2.DATA_ABERTURA_NOVO_ULT AND t1.DATA_FECHAMENTO_NOVO_ULT = t2.DATA_FECHAMENTO_NOVO_ULT
   GROUP BY 1,2,3;

QUIT;


PROC STDIZE DATA=FALECOM_CORRECAO_3 OUT=FALECOM_CORRECAO_3 REPONLY MISSING=0;
	VAR _NUMERIC_;
QUIT;


PROC SQL;

   CREATE TABLE FALECOM_7_CORRIGIDO AS SELECT DISTINCT

      t1.PREFIXO,
	  t1.CARTEIRA,
	  t1.PTL,
	  t1.MCI,
	  t1.DATA_ABERTURA,
	  t1.DATA_FECHAMENTO,
	  t1.HMS_ABERTURA,
	  t1.HMS_FECHAMENTO,
	  t1.DATA_ABERTURA_NOVO_ULT,
	  t1.DATA_FECHAMENTO_NOVO_ULT,
	  t1.HMS_ABERTURA_NOVO_ULT,
	  t1.HMS_FECHAMENTO_NOVO_ULT,
      (t1.DIF_TEMP_1 - t1.CONTAGEM) AS DIF_TEMP_1,
	  t1.DIF_TEMP_2       
	      
      FROM FALECOM_CORRECAO_3 t1;

QUIT;


/***CALCULANDO***/

 
PROC SQL;

   CREATE TABLE FALECOM_8 AS SELECT DISTINCT

      t1.PREFIXO,
	  t1.CARTEIRA,
	  t1.PTL,
	  t1.MCI,
	  t1.DATA_ABERTURA,
	  t1.DATA_FECHAMENTO,
	  t1.HMS_ABERTURA,
	  t1.HMS_FECHAMENTO,
	  t1.DATA_ABERTURA_NOVO_ULT,
	  t1.DATA_FECHAMENTO_NOVO_ULT,
	  t1.HMS_ABERTURA_NOVO_ULT,
	  t1.HMS_FECHAMENTO_NOVO_ULT,
	  t1.DIF_TEMP_1,
	  t1.DIF_TEMP_2,
      
	  DIF_TEMP_1*600 AS DIF_TEMP_1_NOVO,	  



      IFN(t1.DIF_TEMP_2 = "0:00:00"t, 0,

	  IFN(t1.DIF_TEMP_2 >  "0:00:00"t, ((HOUR(t1.DIF_TEMP_2)*60) + MINUTE(t1.DIF_TEMP_2)), 
      (-1*((23 - HOUR(t1.DIF_TEMP_2))*60) -1*(59 - MINUTE(t1.DIF_TEMP_2))))

      )

      AS DIF_TEMP_2_NOVO


	  	       
      FROM FALECOM_7_CORRIGIDO t1;

QUIT;


PROC SQL;

   CREATE TABLE FALECOM_9 AS SELECT DISTINCT

      t1.PREFIXO,
	  t1.CARTEIRA,
	  t1.PTL,
	  t1.MCI,
	  t1.DATA_ABERTURA,
	  t1.DATA_FECHAMENTO,
	  t1.HMS_ABERTURA,
	  t1.HMS_FECHAMENTO,
	  t1.DATA_ABERTURA_NOVO_ULT,
	  t1.DATA_FECHAMENTO_NOVO_ULT,
	  t1.HMS_ABERTURA_NOVO_ULT,
	  t1.HMS_FECHAMENTO_NOVO_ULT,
	  ifn ((t1.DIF_TEMP_1_NOVO + t1.DIF_TEMP_2_NOVO)>1800,1800,(t1.DIF_TEMP_1_NOVO + t1.DIF_TEMP_2_NOVO)) AS START
	  
    FROM FALECOM_8 t1
    INNER JOIN ACORDO_PREFIXO_1 t2 ON t1.PREFIXO = t2.PREFIXO;

QUIT;


PROC SQL;

   CREATE TABLE LEVANTAMENTO_FC AS SELECT DISTINCT

      t1.PREFIXO,
	  t1.CARTEIRA,
	  t1.MCI,
	  t1.DATA_ABERTURA,
	  t1.DATA_FECHAMENTO,
	  t1.HMS_ABERTURA,
	  t1.HMS_FECHAMENTO,
	  t1.DATA_ABERTURA_NOVO_ULT AS DATA_ABERTURA_CORRIGIDO,
	  t1.DATA_FECHAMENTO_NOVO_ULT AS DATA_FECHAMENTO_CORRIGIDO,
	  t1.HMS_ABERTURA_NOVO_ULT AS HMS_ABERTURA_CORRIGIDO,
	  t1.HMS_FECHAMENTO_NOVO_ULT AS HMS_FECHAMENTO_CORRIGIDO,
	  t1.START AS DIFERENCA

    FROM FALECOM_9 t1

    WHERE PREFIXO IN (1881);

QUIT;



/***COLOCANDO A REGUA POR CARTEIRA***/
/***COLOCANDO A REGUA POR CARTEIRA***/
/***COLOCANDO A REGUA POR CARTEIRA***/
/***COLOCANDO A REGUA POR CARTEIRA***/


PROC SQL;

   CREATE TABLE FALECOM_10 AS SELECT DISTINCT

      t1.PREFIXO AS PREFDEP,
	  t1.CARTEIRA AS CTRA,
	  AVG(t1.START) FORMAR 32.2 AS START_MEDIO
    	  
    FROM FALECOM_9 t1
	WHERE t1.CARTEIRA <> 0
    GROUP BY 1,2;

QUIT;


DATA FALECOM_10;
SET FALECOM_10;
TipDepCnx = 1;
run;


PROC SQL;

   CREATE TABLE FALECOM_11 AS SELECT DISTINCT

      t1.PREFDEP,
	  t1.CTRA,
	  t1.TipDepCnx,
	  t1.START_MEDIO AS START_FC,

      IFN(START_MEDIO >= 240, 0, IFN(START_MEDIO >= 180, 5, IFN(START_MEDIO >= 150, 10, IFN(START_MEDIO >= 120, 15, IFN(START_MEDIO >= 90, 20, 25 ))))) AS PONTOS_FALECOM
    	  
    FROM FALECOM_10 t1;

QUIT;


/***COLOCANDO A REGUA POR PREFIXO***/
/***COLOCANDO A REGUA POR PREFIXO***/
/***COLOCANDO A REGUA POR PREFIXO***/
/***COLOCANDO A REGUA POR PREFIXO***/


PROC SQL;

   CREATE TABLE FALECOM_SO_PREF AS SELECT DISTINCT

      t1.PREFIXO,	  
	  t1.PTL,
	  t1.MCI,
	  t1.START
    	  
    FROM FALECOM_9 t1
    ORDER BY 1;

QUIT;


PROC SQL;

   CREATE TABLE FALECOM_PAA_PREF AS SELECT DISTINCT

      input(t2.PREFAGENC, 4.) AS PREFIXO,	  
	  t1.PTL,
	  t1.MCI,
      t1.START
    	  
    FROM FALECOM_9 t1
	INNER JOIN IGR.IGRREDE_&ANOMES. t2 ON t1.PREFIXO = input(t2.PREFDEP, 4.)
	INNER JOIN ACORDO_PREFIXO_1 t3 ON input(t2.PREFAGENC, 4.) = t3.PREFIXO
	WHERE input(t2.PREFAGENC, 4.) <> 0
    ORDER BY 1;

QUIT;


DATA TABELA_FALE_PREF_FINAL;
	MERGE FALECOM_SO_PREF FALECOM_PAA_PREF;
	BY PREFIXO PTL MCI START;
RUN;


PROC STDIZE DATA=TABELA_FALE_PREF_FINAL OUT=TABELA_FALE_PREF_FINAL REPONLY MISSING=0;
	VAR _NUMERIC_;
QUIT;


/*O PAA FOI INCLUIDO*/


PROC SQL;

   CREATE TABLE FALECOM_12 AS SELECT DISTINCT

      t1.PREFIXO AS PREFDEP,
	  AVG(t1.START) FORMAR 32.2 AS START_MEDIO
    	  
    FROM TABELA_FALE_PREF_FINAL t1
    GROUP BY 1;

QUIT;


DATA FALECOM_12;
SET FALECOM_12;
TipDepCnx = 2;
run;


PROC SQL;

   CREATE TABLE FALECOM_13 AS SELECT DISTINCT

      t1.PREFDEP,
	  0 AS CTRA,
	  t1.TipDepCnx,
	  t1.START_MEDIO AS START_FC,

      IFN(START_MEDIO >= 240, 0, IFN(START_MEDIO >= 180, 5, IFN(START_MEDIO >= 150, 10, IFN(START_MEDIO >= 120, 15, IFN(START_MEDIO >= 90, 20, 25 ))))) AS PONTOS_FALECOM
    	  
    FROM FALECOM_12 t1;

QUIT;


/***JUNTANDO***/


PROC SQL;

CREATE TABLE FALECOM_14 AS
 
   SELECT * FROM FALECOM_11
   OUTER UNION CORR
   SELECT * FROM FALECOM_13
   ;

Quit;


PROC SQL;

   CREATE TABLE FALECOM_14 AS SELECT DISTINCT

      *
    	  
   FROM FALECOM_14
   ORDER BY 1,2 ;

QUIT;



/***COLOCANDO A REGUA NA HIERARQUIA***/
/***COLOCANDO A REGUA NA HIERARQUIA***/
/***COLOCANDO A REGUA NA HIERARQUIA***/
/***COLOCANDO A REGUA NA HIERARQUIA***/


PROC SQL;

   CREATE TABLE FC_FINAL_HIER AS SELECT DISTINCT

      t1.PREFIXO,
      t1.MCI, 
	  t1.START,
	  t2.PREFSUPREG AS GEREV,
	  t2.PREFSUPEST AS SUPER,
	  t2.PREFUEN AS DIR,
	  8592 AS NOVADIR,
	  8166 AS VICE
	  
    FROM FALECOM_9 t1
    INNER JOIN IGR.IGRREDE_&ANOMES. t2 ON t1.PREFIXO = input(t2.PREFDEP, 4.)
	GROUP BY 1;

QUIT;


/*GEREV*/
/*GEREV*/
/*GEREV*/
/*GEREV*/


PROC SQL;

   CREATE TABLE FC_FINAL_HIER_GEREV AS SELECT DISTINCT

      input(t1.GEREV, 4.) AS PREFDEP,
	  0 AS CTRA,
	  AVG(t1.START) FORMAR 32.2 AS START_MEDIO
    	  
    FROM FC_FINAL_HIER t1
    GROUP BY 1;

QUIT;


DATA FC_FINAL_HIER_GEREV;
SET FC_FINAL_HIER_GEREV;
TipDepCnx = 0;
run;


PROC SQL;

   CREATE TABLE FC_FINAL_HIER_GEREV_1 AS SELECT DISTINCT

      t1.PREFDEP,
	  t1.CTRA,
	  t1.TipDepCnx,
	  t1.START_MEDIO AS START_FC,

      IFN(START_MEDIO >= 240, 0, IFN(START_MEDIO >= 180, 5, IFN(START_MEDIO >= 150, 10, IFN(START_MEDIO >= 120, 15, IFN(START_MEDIO >= 90, 20, 25 ))))) AS PONTOS_FALECOM
    	  
    FROM FC_FINAL_HIER_GEREV t1
	WHERE t1.PREFDEP <> 0
    ORDER BY 1,2;

QUIT;


/*SUPER*/
/*SUPER*/
/*SUPER*/
/*SUPER*/


PROC SQL;

   CREATE TABLE FC_FINAL_HIER_SUPER AS SELECT DISTINCT

      input(t1.SUPER, 4.) AS PREFDEP,
	  0 AS CTRA,
	  AVG(t1.START) FORMAR 32.2 AS START_MEDIO
    	  
    FROM FC_FINAL_HIER t1
    GROUP BY 1;

QUIT;


DATA FC_FINAL_HIER_SUPER;
SET FC_FINAL_HIER_SUPER;
TipDepCnx = 0;
run;


PROC SQL;

   CREATE TABLE FC_FINAL_HIER_SUPER_1 AS SELECT DISTINCT

      t1.PREFDEP,
	  t1.CTRA,
	  t1.TipDepCnx,
	  t1.START_MEDIO AS START_FC,

      IFN(START_MEDIO >= 240, 0, IFN(START_MEDIO >= 180, 5, IFN(START_MEDIO >= 150, 10, IFN(START_MEDIO >= 120, 15, IFN(START_MEDIO >= 90, 20, 25 ))))) AS PONTOS_FALECOM
    	  
    FROM FC_FINAL_HIER_SUPER t1
    ORDER BY 1,2;

QUIT;


/**DIR**/
/**DIR**/
/**DIR**/
/**DIR**/


PROC SQL;

   CREATE TABLE FC_FINAL_HIER_DIR AS SELECT DISTINCT

      input(t1.DIR, 4.) AS PREFDEP,
	  0 AS CTRA,
	  AVG(t1.START) FORMAR 32.2 AS START_MEDIO
    	  
    FROM FC_FINAL_HIER t1
    GROUP BY 1;

QUIT;


DATA FC_FINAL_HIER_DIR;
SET FC_FINAL_HIER_DIR;
TipDepCnx = 0;
run;


PROC SQL;
   CREATE TABLE FC_FINAL_HIER_DIR_1 AS SELECT DISTINCT

      t1.PREFDEP,
	  t1.CTRA,
	  t1.TipDepCnx,
	  t1.START_MEDIO AS START_FC,
      IFN(START_MEDIO >= 240, 0, IFN(START_MEDIO >= 180, 5, IFN(START_MEDIO >= 150, 10, IFN(START_MEDIO >= 120, 15, IFN(START_MEDIO >= 90, 20, 25 ))))) AS PONTOS_FALECOM
    	  
    FROM FC_FINAL_HIER_DIR t1
    ORDER BY 1,2;

QUIT;


/**NOVADIR**/
/**NOVADIR**/
/**NOVADIR**/
/**NOVADIR**/


PROC SQL;

   CREATE TABLE FC_FINAL_HIER_NOVADIR AS SELECT DISTINCT

      t1.NOVADIR AS PREFDEP,
	  0 AS CTRA,
	  AVG(t1.START) FORMAR 32.2 AS START_MEDIO
    	  
    FROM FC_FINAL_HIER t1
    GROUP BY 1;

QUIT;


DATA FC_FINAL_HIER_NOVADIR;
SET FC_FINAL_HIER_NOVADIR;
TipDepCnx = 0;
run;


PROC SQL;

   CREATE TABLE FC_FINAL_HIER_NOVADIR_1 AS SELECT DISTINCT

      t1.PREFDEP,
	  t1.CTRA,
	  t1.TipDepCnx,
	  t1.START_MEDIO AS START_FC,
      IFN(START_MEDIO >= 240, 0, IFN(START_MEDIO >= 180, 5, IFN(START_MEDIO >= 150, 10, IFN(START_MEDIO >= 120, 15, IFN(START_MEDIO >= 90, 20, 25 ))))) AS PONTOS_FALECOM
    	  
    FROM FC_FINAL_HIER_NOVADIR t1
    ORDER BY 1,2;

QUIT;


/**VICE**/
/**VICE**/
/**VICE**/
/**VICE**/


PROC SQL;

   CREATE TABLE FC_FINAL_HIER_VICE AS SELECT DISTINCT

      t1.VICE AS PREFDEP,
	  0 AS CTRA,
	  AVG(t1.START) FORMAR 32.2 AS START_MEDIO
    	  
    FROM FC_FINAL_HIER t1
    GROUP BY 1;

QUIT;


DATA FC_FINAL_HIER_VICE;
SET FC_FINAL_HIER_VICE;
TipDepCnx = 0;
run;


PROC SQL;

   CREATE TABLE FC_FINAL_HIER_VICE_1 AS SELECT DISTINCT

      t1.PREFDEP,
	  t1.CTRA,
	  t1.TipDepCnx,
	  t1.START_MEDIO AS START_FC,

      IFN(START_MEDIO >= 240, 0, IFN(START_MEDIO >= 180, 5, IFN(START_MEDIO >= 150, 10, IFN(START_MEDIO >= 120, 15, IFN(START_MEDIO >= 90, 20, 25 ))))) AS PONTOS_FALECOM
    	  
    FROM FC_FINAL_HIER_VICE t1
    ORDER BY 1,2;

QUIT;


/***JUNTANDO***/


PROC SQL;

CREATE TABLE FALECOM_200 AS
 
   SELECT * FROM FALECOM_14
   OUTER UNION CORR
   SELECT * FROM FC_FINAL_HIER_GEREV_1
   OUTER UNION CORR
   SELECT * FROM FC_FINAL_HIER_SUPER_1
   OUTER UNION CORR
   SELECT * FROM FC_FINAL_HIER_DIR_1
   OUTER UNION CORR
   SELECT * FROM FC_FINAL_HIER_NOVADIR_1
   OUTER UNION CORR
   SELECT * FROM FC_FINAL_HIER_VICE_1
   ;

Quit;



PROC SQL;

   CREATE TABLE FALECOM_200 AS SELECT DISTINCT
*
    FROM FALECOM_200 t1
    ORDER BY 1,2;

QUIT;




/************GAT PRESENCIAL**************/
/************GAT PRESENCIAL**************/
/************GAT PRESENCIAL**************/
/************GAT PRESENCIAL**************/


PROC SQL;

   CONNECT TO DB2 (AUTHDOMAIN=DB2SGCEN DATABASE=DB23P41);
   CREATE TABLE AUX.GAT_PRESENCIAL AS

   SELECT DISTINCT
    
      NR_SLCT_ATDT,
	  CD_CLI,
	  TS_INC_EPR,
	  TS_INC_ATDT,
      CD_EST_PTL_ATDT,
	  DT_HST_PTL_ATDT,
	  CD_UOR_SLCT

   FROM CONNECTION TO DB2
      (SELECT DISTINCT

      t1.NR_SLCT_ATDT,
	  t2.CD_CLI,
	  t1.TS_INC_EPR,
	  t1.TS_INC_ATDT,
	  t1.CD_EST_PTL_ATDT,
	  t1.DT_HST_PTL_ATDT,
	  t1.CD_UOR_SLCT

      FROM DB2GAT.HST_PTL_ATDT t1
	  INNER JOIN DB2GAT.HST_SLCT_ATDT t2 ON (t1.CD_UOR_SLCT = t2.CD_UOR_SLCT AND t1.NR_SLCT_ATDT = t2.NR_SLCT_ATDT AND t1.DT_HST_PTL_ATDT = t2.DT_HST_SLCT_ATDT)

	  WHERE YEAR(t1.DT_HST_PTL_ATDT) = &ANO_ATUAL. AND MONTH(t1.DT_HST_PTL_ATDT) = &MES_POSICAO.) ;

   DISCONNECT FROM DB2;

QUIT;


PROC STDIZE DATA=AUX.GAT_PRESENCIAL OUT=AUX.GAT_PRESENCIAL REPONLY MISSING=0;
	VAR _NUMERIC_;
QUIT;



PROC SQL;

   CREATE TABLE GAT_PRESENCIAL_2 AS SELECT DISTINCT
   
      t1.CD_CLI AS MCI,
	  t1.CD_EST_PTL_ATDT,
	  t1.TS_INC_EPR AS TS_ABERTURA,
	  t1.TS_INC_ATDT AS TS_FECHAMENTO, 
      DATEPART(t1.TS_INC_EPR) FORMAT yymmdd10. AS DATA_ABERTURA, 
	  DATEPART(t1.TS_INC_ATDT) FORMAT yymmdd10. AS DATA_FECHAMENTO, 
	  TIMEPART(t1.TS_INC_EPR) FORMAT=TIME8. AS HMS_ABERTURA, 
	  TIMEPART(t1.TS_INC_ATDT) FORMAT=TIME8. AS HMS_FECHAMENTO,
	  WEEKDAY(DATEPART(t1.TS_INC_EPR)) AS D_SEM_ABERTURA,
	  WEEKDAY(DATEPART(t1.TS_INC_ATDT)) AS D_SEM_FECHAMENTO,
      t1.CD_UOR_SLCT,
      INPUT(t2.PrefDep, d4.) as PREFIXO_DE_USO 
    	  
    FROM AUX.GAT_PRESENCIAL t1
	INNER JOIN IGR.IGRREDE_&ANOMES. t2 ON t1.CD_UOR_SLCT = INPUT(t2.UOR, d9.)
    WHERE t1.CD_CLI <> 0 AND t1.CD_EST_PTL_ATDT IN (40) and t1.DT_HST_PTL_ATDT <= &D1.;

QUIT;


/*ENCARTEIRANDO*/
/*ENCARTEIRANDO*/


PROC SQL;

      CREATE TABLE GAT_PRESENCIAL_51_ANT AS SELECT DISTINCT
      
	  t2.PREFIXO,
	  t2.CARTEIRA,
	  t1.MCI,
	  t1.TS_ABERTURA,
	  t1.TS_FECHAMENTO,      
	  t1.HMS_ABERTURA, 
	  t1.HMS_FECHAMENTO,
	  t1.DATA_ABERTURA, 
	  t1.DATA_FECHAMENTO,
	  t1.D_SEM_ABERTURA,
	  t1.D_SEM_FECHAMENTO,
	  t1.PREFIXO_DE_USO
		  
      FROM GAT_PRESENCIAL_2 t1
      LEFT JOIN CLIENTES t2 ON (t1.MCI = t2.MCI)
      ;      

QUIT;


PROC STDIZE DATA=GAT_PRESENCIAL_51_ANT OUT=GAT_PRESENCIAL_51_ANT REPONLY MISSING=0;
	VAR _NUMERIC_;
QUIT;


PROC SQL;

      CREATE TABLE GAT_PRESENCIAL_51 AS SELECT DISTINCT
      
	  IFN(t1.PREFIXO_DE_USO = t1.PREFIXO, t1.PREFIXO, t1.PREFIXO_DE_USO) AS PREFIXO,
	  IFN(t1.PREFIXO_DE_USO <> t1.PREFIXO, 0, t1.CARTEIRA) AS CARTEIRA,
	  t1.MCI,
	  t1.TS_ABERTURA,
	  t1.TS_FECHAMENTO,      
	  t1.HMS_ABERTURA, 
	  t1.HMS_FECHAMENTO,
	  t1.DATA_ABERTURA, 
	  t1.DATA_FECHAMENTO,
	  t1.D_SEM_ABERTURA,
	  t1.D_SEM_FECHAMENTO,
	  t1.PREFIXO_DE_USO
		  
      FROM GAT_PRESENCIAL_51_ANT t1
        ;      

QUIT;


PROC STDIZE DATA=GAT_PRESENCIAL_51 OUT=GAT_PRESENCIAL_51 REPONLY MISSING=0;
	VAR _NUMERIC_;
QUIT;


/*********APLICANDO CORRECAO SAB E DOM**********/
/*********APLICANDO CORRECAO SAB E DOM**********/


PROC SQL;

   CREATE TABLE GAT_PRESENCIAL_21 AS SELECT DISTINCT

      t1.PREFIXO,
	  t1.CARTEIRA,
	  t1.MCI,
	  t1.TS_ABERTURA,
	  t1.TS_FECHAMENTO,
      t1.HMS_ABERTURA,
	  t1.HMS_FECHAMENTO,
	  t1.DATA_ABERTURA,
	  t1.DATA_FECHAMENTO,
	  t1.D_SEM_ABERTURA,
	  t1.D_SEM_FECHAMENTO,

      IFN(t1.D_SEM_ABERTURA NOT IN (1,7), IFN(HOUR(t1.HMS_ABERTURA) > 17, IFN(t1.D_SEM_ABERTURA IN (2,3,4,5), t1.DATA_ABERTURA + 1, t1.DATA_ABERTURA + 3)
      , t1.DATA_ABERTURA), IFN(t1.D_SEM_ABERTURA IN (1), t1.DATA_ABERTURA + 1, t1.DATA_ABERTURA + 2)) FORMAT yymmdd10. AS DATA_ABERTURA_NOVO_1,
	  

      IFN(t1.D_SEM_ABERTURA NOT IN (1,7), IFN(HOUR(t1.HMS_ABERTURA) < 8 OR HOUR(t1.HMS_ABERTURA) > 17, "8:0:0"t, t1.HMS_ABERTURA), "8:0:0"t) FORMAT=TIME8. AS HMS_ABERTURA_NOVO_1,
  
      IFN(t1.D_SEM_FECHAMENTO NOT IN (1,7), IFN(HOUR(t1.HMS_FECHAMENTO) > 17, IFN(t1.D_SEM_FECHAMENTO IN (2,3,4,5), t1.DATA_FECHAMENTO + 1, t1.DATA_FECHAMENTO + 3)
      , t1.DATA_FECHAMENTO), IFN(t1.D_SEM_FECHAMENTO IN (1), t1.DATA_FECHAMENTO + 1, t1.DATA_FECHAMENTO + 2)) FORMAT yymmdd10. AS DATA_FECHAMENTO_NOVO_1,


      IFN(t1.D_SEM_FECHAMENTO NOT IN (1,7), IFN(HOUR(t1.HMS_FECHAMENTO) < 8 OR HOUR(t1.HMS_FECHAMENTO) > 17, "8:0:0"t, t1.HMS_FECHAMENTO), "8:0:0"t) FORMAT=TIME8. AS HMS_FECHAMENTO_NOVO_1,

	  t1.PREFIXO_DE_USO
             

   FROM GAT_PRESENCIAL_51 t1;

QUIT;


/*********APLICANDO CORRECAO FERIADO**********/
/*********APLICANDO CORRECAO FERIADO**********/


PROC SQL;

      CREATE TABLE GAT_PRESENCIAL_22 AS SELECT 
      
	  t1.PREFIXO,
	  t1.CARTEIRA,
	  t1.MCI,
	  t1.TS_ABERTURA,
	  t1.TS_FECHAMENTO,
      t1.HMS_Abertura,
	  t1.HMS_Fechamento,
	  t1.DATA_ABERTURA,
	  t1.DATA_FECHAMENTO,
	  t1.D_SEM_ABERTURA,
	  t1.D_SEM_FECHAMENTO,
	  t1.DATA_ABERTURA_NOVO_1,
	  t1.DATA_FECHAMENTO_NOVO_1,
	  t1.HMS_ABERTURA_NOVO_1,
	  t1.HMS_FECHAMENTO_NOVO_1,
	  t2.IND_FERIADO AS IND_FER_ABERT,
	  t3.IND_FERIADO AS IND_FER_FECH,
	  t1.PREFIXO_DE_USO
	  
      FROM GAT_PRESENCIAL_21 t1
      LEFT JOIN PREFIXO_FERIADO_1 t2 ON (t1.PREFIXO = t2.PREFIXO AND t1.DATA_ABERTURA_NOVO_1 = t2.DT_FER)
	  LEFT JOIN PREFIXO_FERIADO_1 t3 ON (t1.PREFIXO = t3.PREFIXO AND t1.DATA_FECHAMENTO_NOVO_1 = t3.DT_FER)
      GROUP BY 1,2,3;      

QUIT;

PROC STDIZE OUT=GAT_PRESENCIAL_22 REPONLY MISSING=0;
	VAR _NUMERIC_;
QUIT;


PROC SQL;

      CREATE TABLE GAT_PRESENCIAL_23 AS SELECT 
      
	  t1.PREFIXO,
	  t1.CARTEIRA,
	  t1.MCI,
	  t1.TS_ABERTURA,
	  t1.TS_FECHAMENTO,
      t1.HMS_ABERTURA,
	  t1.HMS_FECHAMENTO,
	  t1.DATA_ABERTURA,
	  t1.DATA_FECHAMENTO,
	  t1.D_SEM_ABERTURA,
	  t1.D_SEM_FECHAMENTO,
	  t1.DATA_ABERTURA_NOVO_1,
	  t1.DATA_FECHAMENTO_NOVO_1,
	  t1.HMS_ABERTURA_NOVO_1,
	  t1.HMS_FECHAMENTO_NOVO_1,
	  t1.IND_FER_ABERT,
	  t1.IND_FER_FECH,

      IFN(DATA_ABERTURA_NOVO_1 = '04JUL2019'd, DATA_ABERTURA_NOVO_1 + 2, 
      IFN(IND_FER_ABERT = 1, 
      IFN(WEEKDAY(DATA_ABERTURA_NOVO_1) = 6, DATA_ABERTURA_NOVO_1 + 3, 
      IFN(WEEKDAY(DATA_ABERTURA_NOVO_1) = 7, DATA_ABERTURA_NOVO_1 + 2, DATA_ABERTURA_NOVO_1 + 1)), DATA_ABERTURA_NOVO_1)) FORMAT yymmdd10. AS DATA_ABERTURA_NOVO_2,

      IFN(DATA_ABERTURA_NOVO_1 = '06MAR2019'd, "12:0:0"t, IFN(IND_FER_ABERT = 1, "8:0:0"t, HMS_ABERTURA_NOVO_1)) FORMAT = TIME8. AS HMS_ABERTURA_NOVO_2,
	  

      IFN(DATA_FECHAMENTO_NOVO_1 = '04JUL2019'd, DATA_FECHAMENTO_NOVO_1 + 2, 
      IFN(IND_FER_FECH = 1, 
      IFN(WEEKDAY(DATA_FECHAMENTO_NOVO_1) = 6, DATA_FECHAMENTO_NOVO_1 + 3, 
      IFN(WEEKDAY(DATA_FECHAMENTO_NOVO_1) = 7, DATA_FECHAMENTO_NOVO_1 + 2, DATA_FECHAMENTO_NOVO_1 + 1)), DATA_FECHAMENTO_NOVO_1)) FORMAT yymmdd10. AS DATA_FECHAMENTO_NOVO_2,

	  IFN(DATA_FECHAMENTO_NOVO_1 = '06MAR2019'd, "12:0:0"t, IFN(IND_FER_FECH = 1, "8:0:0"t, HMS_FECHAMENTO_NOVO_1)) FORMAT = TIME8. AS HMS_FECHAMENTO_NOVO_2,

	  t1.PREFIXO_DE_USO
		  
      FROM GAT_PRESENCIAL_22 t1;      

QUIT;


/*********APLICANDO CORRECAO FERIADO PELA SEGUNDA VEZ**********/
/*********APLICANDO CORRECAO FERIADO PELA SEGUNDA VEZ**********/


PROC SQL;

      CREATE TABLE GAT_PRESENCIAL_24 AS SELECT 
      
	  t1.PREFIXO,
	  t1.CARTEIRA,
	  t1.MCI,
	  t1.TS_ABERTURA,
	  t1.TS_FECHAMENTO,
      t1.HMS_Abertura,
	  t1.HMS_Fechamento,
	  t1.DATA_ABERTURA,
	  t1.DATA_FECHAMENTO,
	  t1.D_SEM_ABERTURA,
	  t1.D_SEM_FECHAMENTO,
	  t1.DATA_ABERTURA_NOVO_1,
	  t1.DATA_FECHAMENTO_NOVO_1,
	  t1.HMS_ABERTURA_NOVO_1,
	  t1.HMS_FECHAMENTO_NOVO_1,
	  t1.DATA_ABERTURA_NOVO_2,
	  t1.DATA_FECHAMENTO_NOVO_2,
	  t1.HMS_ABERTURA_NOVO_2,
	  t1.HMS_FECHAMENTO_NOVO_2,
	  t2.IND_FERIADO AS IND_FER_ABERT,
	  t3.IND_FERIADO AS IND_FER_FECH,
	  t1.PREFIXO_DE_USO
	  
      FROM GAT_PRESENCIAL_23 t1
      LEFT JOIN PREFIXO_FERIADO_1 t2 ON (t1.PREFIXO = t2.PREFIXO AND t1.DATA_ABERTURA_NOVO_2 = t2.DT_FER)
	  LEFT JOIN PREFIXO_FERIADO_1 t3 ON (t1.PREFIXO = t3.PREFIXO AND t1.DATA_FECHAMENTO_NOVO_2 = t3.DT_FER)
      GROUP BY 1,2,3;      

QUIT;


PROC STDIZE OUT=GAT_PRESENCIAL_24 REPONLY MISSING=0;
	VAR _NUMERIC_;
QUIT;


PROC SQL;

      CREATE TABLE GAT_PRESENCIAL_25 AS SELECT 
      
	  t1.PREFIXO,
	  t1.CARTEIRA,
	  t1.MCI,
	  t1.TS_ABERTURA,
	  t1.TS_FECHAMENTO,
      t1.HMS_ABERTURA,
	  t1.HMS_FECHAMENTO,
	  t1.DATA_ABERTURA,
	  t1.DATA_FECHAMENTO,
	  t1.D_SEM_ABERTURA,
	  t1.D_SEM_FECHAMENTO,
	  t1.DATA_ABERTURA_NOVO_1,
	  t1.DATA_FECHAMENTO_NOVO_1,
	  t1.HMS_ABERTURA_NOVO_1,
	  t1.HMS_FECHAMENTO_NOVO_1,
	  t1.DATA_ABERTURA_NOVO_2,
	  t1.DATA_FECHAMENTO_NOVO_2,
	  t1.HMS_ABERTURA_NOVO_2,
	  t1.HMS_FECHAMENTO_NOVO_2,
	  t1.IND_FER_ABERT,
	  t1.IND_FER_FECH,

      IFN(DATA_ABERTURA_NOVO_2 = '04JUL2019'd, DATA_ABERTURA_NOVO_2 + 2, 
      IFN(IND_FER_ABERT = 1, 
      IFN(WEEKDAY(DATA_ABERTURA_NOVO_2) = 6, DATA_ABERTURA_NOVO_2 + 3, 
      IFN(WEEKDAY(DATA_ABERTURA_NOVO_2) = 7, DATA_ABERTURA_NOVO_2 + 2, DATA_ABERTURA_NOVO_2 + 1)), DATA_ABERTURA_NOVO_2)) FORMAT yymmdd10. AS DATA_ABERTURA_NOVO_3,

      IFN(DATA_ABERTURA_NOVO_2 = '06MAR2019'd, "12:0:0"t, IFN(IND_FER_ABERT = 1, "8:0:0"t, HMS_ABERTURA_NOVO_2)) FORMAT = TIME8. AS HMS_ABERTURA_NOVO_3,
	  
      IFN(DATA_FECHAMENTO_NOVO_2 = '04JUL2019'd, DATA_FECHAMENTO_NOVO_2 + 2, 
      IFN(IND_FER_FECH = 1, 
      IFN(WEEKDAY(DATA_FECHAMENTO_NOVO_2) = 6, DATA_FECHAMENTO_NOVO_2 + 3, 
      IFN(WEEKDAY(DATA_FECHAMENTO_NOVO_2) = 7, DATA_FECHAMENTO_NOVO_2 + 2, DATA_FECHAMENTO_NOVO_2 + 1)), DATA_FECHAMENTO_NOVO_2)) FORMAT yymmdd10. AS DATA_FECHAMENTO_NOVO_3,

	  IFN(DATA_FECHAMENTO_NOVO_2 = '06MAR2019'd, "12:0:0"t, IFN(IND_FER_FECH = 1, "8:0:0"t, HMS_FECHAMENTO_NOVO_2)) FORMAT = TIME8. AS HMS_FECHAMENTO_NOVO_3,

	  t1.PREFIXO_DE_USO
		  
      FROM GAT_PRESENCIAL_24 t1;      

QUIT;


/*********APLICANDO CORRECAO FERIADO PELA TERCEIRA VEZ**********/
/*********APLICANDO CORRECAO FERIADO PELA TERCEIRA VEZ**********/


PROC SQL;

      CREATE TABLE GAT_PRESENCIAL_26 AS SELECT 
      
	  t1.PREFIXO,
	  t1.CARTEIRA,
	  t1.MCI,
	  t1.TS_ABERTURA,
	  t1.TS_FECHAMENTO,
      t1.HMS_Abertura,
	  t1.HMS_Fechamento,
	  t1.DATA_ABERTURA,
	  t1.DATA_FECHAMENTO,
	  t1.D_SEM_ABERTURA,
	  t1.D_SEM_FECHAMENTO,
	  t1.DATA_ABERTURA_NOVO_1,
	  t1.DATA_FECHAMENTO_NOVO_1,
	  t1.HMS_ABERTURA_NOVO_1,
	  t1.HMS_FECHAMENTO_NOVO_1,
	  t1.DATA_ABERTURA_NOVO_2,
	  t1.DATA_FECHAMENTO_NOVO_2,
	  t1.HMS_ABERTURA_NOVO_2,
	  t1.HMS_FECHAMENTO_NOVO_2,
	  t1.DATA_ABERTURA_NOVO_3,
	  t1.DATA_FECHAMENTO_NOVO_3,
	  t1.HMS_ABERTURA_NOVO_3,
	  t1.HMS_FECHAMENTO_NOVO_3,
	  t2.IND_FERIADO AS IND_FER_ABERT,
	  t3.IND_FERIADO AS IND_FER_FECH,
	  t1.PREFIXO_DE_USO
	  
      FROM GAT_PRESENCIAL_25 t1
      LEFT JOIN PREFIXO_FERIADO_1 t2 ON (t1.PREFIXO = t2.PREFIXO AND t1.DATA_ABERTURA_NOVO_3 = t2.DT_FER)
	  LEFT JOIN PREFIXO_FERIADO_1 t3 ON (t1.PREFIXO = t3.PREFIXO AND t1.DATA_FECHAMENTO_NOVO_3 = t3.DT_FER)
      GROUP BY 1,2,3;      

QUIT;


PROC STDIZE OUT=GAT_PRESENCIAL_26 REPONLY MISSING=0;
	VAR _NUMERIC_;
QUIT;


PROC SQL;

      CREATE TABLE GAT_PRESENCIAL_27 AS SELECT 
      
	  t1.PREFIXO,
	  t1.CARTEIRA,
	  t1.MCI,
	  t1.TS_ABERTURA,
	  t1.TS_FECHAMENTO,
      t1.HMS_ABERTURA,
	  t1.HMS_FECHAMENTO,
	  t1.DATA_ABERTURA,
	  t1.DATA_FECHAMENTO,
	  t1.D_SEM_ABERTURA,
	  t1.D_SEM_FECHAMENTO,
	  t1.DATA_ABERTURA_NOVO_1,
	  t1.DATA_FECHAMENTO_NOVO_1,
	  t1.HMS_ABERTURA_NOVO_1,
	  t1.HMS_FECHAMENTO_NOVO_1,
	  t1.DATA_ABERTURA_NOVO_2,
	  t1.DATA_FECHAMENTO_NOVO_2,
	  t1.HMS_ABERTURA_NOVO_2,
	  t1.HMS_FECHAMENTO_NOVO_2,
	  t1.DATA_ABERTURA_NOVO_3,
	  t1.DATA_FECHAMENTO_NOVO_3,
	  t1.HMS_ABERTURA_NOVO_3,
	  t1.HMS_FECHAMENTO_NOVO_3,
	  t1.IND_FER_ABERT,
	  t1.IND_FER_FECH,

      IFN(DATA_ABERTURA_NOVO_3 = '04JUL2019'd, DATA_ABERTURA_NOVO_3 + 2, 
      IFN(IND_FER_ABERT = 1, 
      IFN(WEEKDAY(DATA_ABERTURA_NOVO_3) = 6, DATA_ABERTURA_NOVO_3 + 3, 
      IFN(WEEKDAY(DATA_ABERTURA_NOVO_3) = 7, DATA_ABERTURA_NOVO_3 + 2, DATA_ABERTURA_NOVO_3 + 1)), DATA_ABERTURA_NOVO_3)) FORMAT yymmdd10. AS DATA_ABERTURA_NOVO_ULT,

      IFN(DATA_ABERTURA_NOVO_3 = '06MAR2019'd, "12:0:0"t, IFN(IND_FER_ABERT = 1, "8:0:0"t, HMS_ABERTURA_NOVO_3)) FORMAT = TIME8. AS HMS_ABERTURA_NOVO_ULT,
	  
      IFN(DATA_FECHAMENTO_NOVO_3 = '04JUL2019'd, DATA_FECHAMENTO_NOVO_3 + 2, 
      IFN(IND_FER_FECH = 1, 
      IFN(WEEKDAY(DATA_FECHAMENTO_NOVO_3) = 6, DATA_FECHAMENTO_NOVO_3 + 3, 
      IFN(WEEKDAY(DATA_FECHAMENTO_NOVO_3) = 7, DATA_FECHAMENTO_NOVO_3 + 2, DATA_FECHAMENTO_NOVO_3 + 1)), DATA_FECHAMENTO_NOVO_3)) FORMAT yymmdd10. AS DATA_FECHAMENTO_NOVO_ULT,

	  IFN(DATA_FECHAMENTO_NOVO_3 = '06MAR2019'd, "12:0:0"t, IFN(IND_FER_FECH = 1, "8:0:0"t, HMS_FECHAMENTO_NOVO_3)) FORMAT = TIME8. AS HMS_FECHAMENTO_NOVO_ULT,

	  t1.PREFIXO_DE_USO
		  
      FROM GAT_PRESENCIAL_26 t1;      

QUIT;


/*CORRIGINDO DIAS*/


PROC SQL;

   CREATE TABLE GAT_PRESENCIAL_28 AS SELECT DISTINCT
   
      t1.PREFIXO,
	  t1.CARTEIRA,
      t1.MCI,
	  t1.TS_ABERTURA,
	  t1.TS_FECHAMENTO,      
	  t1.HMS_ABERTURA, 
	  t1.HMS_FECHAMENTO,
	  t1.DATA_ABERTURA, 
	  t1.DATA_FECHAMENTO,
	  t1.DATA_ABERTURA_NOVO_ULT,
      IFN(t1.DATA_ABERTURA_NOVO_ULT <> DATA_FECHAMENTO_NOVO_ULT, t1.DATA_ABERTURA_NOVO_ULT, t1.DATA_FECHAMENTO_NOVO_ULT) AS DATA_FECHAMENTO_NOVO_ULT,
	  t1.HMS_ABERTURA_NOVO_ULT,
      IFN(t1.DATA_ABERTURA_NOVO_ULT <> DATA_FECHAMENTO_NOVO_ULT, "18:0:0"t, t1.HMS_FECHAMENTO_NOVO_ULT) FORMAT = TIME8. AS HMS_FECHAMENTO_NOVO_ULT,

	  t1.HMS_FECHAMENTO_NOVO_ULT,
      t1.PREFIXO_DE_USO  
    	  
   FROM GAT_PRESENCIAL_27 t1;

QUIT;


/*CALCULANDO*/

PROC SQL;

   CREATE TABLE GAT_PRESENCIAL_3 AS SELECT DISTINCT
   
      t1.PREFIXO,
	  t1.CARTEIRA,
      t1.MCI,
	  t1.TS_ABERTURA,
	  t1.TS_FECHAMENTO,      
	  t1.HMS_ABERTURA, 
	  t1.HMS_FECHAMENTO,
	  t1.DATA_ABERTURA, 
	  t1.DATA_FECHAMENTO,
	  t1.DATA_ABERTURA_NOVO_ULT,
	  t1.DATA_FECHAMENTO_NOVO_ULT,
	  t1.HMS_ABERTURA_NOVO_ULT,
	  t1.HMS_FECHAMENTO_NOVO_ULT,
      (t1.HMS_FECHAMENTO_NOVO_ULT - t1.HMS_ABERTURA_NOVO_ULT) FORMAT = TIME8. AS DIF_TEMPO,
      t1.PREFIXO_DE_USO  
    	  
   FROM GAT_PRESENCIAL_28 t1
   WHERE t1.DATA_ABERTURA = t1.DATA_FECHAMENTO;

QUIT;


PROC SQL;

   CREATE TABLE GAT_PRESENCIAL_4 AS SELECT DISTINCT
   
      t1.PREFIXO,
	  t1.CARTEIRA,
      t1.MCI,
	  t1.TS_ABERTURA,
	  t1.TS_FECHAMENTO,      
	  t1.HMS_ABERTURA, 
	  t1.HMS_FECHAMENTO,
	  t1.DATA_ABERTURA, 
	  t1.DATA_FECHAMENTO,
	  t1.DATA_ABERTURA_NOVO_ULT,
	  t1.DATA_FECHAMENTO_NOVO_ULT,
	  t1.HMS_ABERTURA_NOVO_ULT,
	  t1.HMS_FECHAMENTO_NOVO_ULT,
      t1.DIF_TEMPO,
      (HOUR(t1.DIF_TEMPO)*60 + MINUTE(t1.DIF_TEMPO)) AS DIFERENCA,
	  t1.PREFIXO_DE_USO 
    	  
   FROM GAT_PRESENCIAL_3 t1
   INNER JOIN ACORDO_PREFIXO_1 t2 ON t1.PREFIXO = t2.PREFIXO;

QUIT;


PROC SQL;

   CREATE TABLE LEVANTAMENTO_PRES AS SELECT DISTINCT

      t1.PREFIXO,
	  t1.CARTEIRA,
	  t1.MCI,
	  t1.DATA_ABERTURA,
	  t1.DATA_FECHAMENTO,
	  t1.HMS_ABERTURA,
	  t1.HMS_FECHAMENTO,
	  t1.DATA_ABERTURA_NOVO_ULT AS DATA_ABERTURA_CORRIGIDO,
	  t1.DATA_FECHAMENTO_NOVO_ULT AS DATA_FECHAMENTO_CORRIGIDO,
	  t1.HMS_ABERTURA_NOVO_ULT AS HMS_ABERTURA_CORRIGIDO,
	  t1.HMS_FECHAMENTO_NOVO_ULT AS HMS_FECHAMENTO_CORRIGIDO,
	  t1.DIFERENCA,
	  t1.PREFIXO_DE_USO 

    FROM GAT_PRESENCIAL_4 t1

    WHERE PREFIXO IN (1881);

QUIT;


/***COLOCANDO A REGUA POR CARTEIRA***/
/***COLOCANDO A REGUA POR CARTEIRA***/
/***COLOCANDO A REGUA POR CARTEIRA***/
/***COLOCANDO A REGUA POR CARTEIRA***/


PROC SQL;

   CREATE TABLE GAT_PRESENCIAL_6 AS SELECT DISTINCT

      t1.PREFIXO AS PREFDEP,
	  t1.CARTEIRA AS CTRA,
	  AVG(t1.DIFERENCA) FORMAT 32.2 AS DIFERENCA_MEDIA
    	  
    FROM GAT_PRESENCIAL_4 t1
	WHERE t1.CARTEIRA <>0
    GROUP BY 1,2;

QUIT;


DATA GAT_PRESENCIAL_6;
SET GAT_PRESENCIAL_6;
TipDepCnx = 1;
run;


PROC SQL;

   CREATE TABLE GAT_PRESENCIAL_7 AS SELECT DISTINCT

      t1.PREFDEP,
	  t1.CTRA,
	  t1.TipDepCnx,
	  t1.DIFERENCA_MEDIA AS START_PRES,

      IFN(t1.DIFERENCA_MEDIA >= 40, 0, IFN(t1.DIFERENCA_MEDIA >= 35, 5, IFN(t1.DIFERENCA_MEDIA >= 30, 10, IFN(t1.DIFERENCA_MEDIA >= 25, 15, IFN(t1.DIFERENCA_MEDIA >= 20, 20, 25 ))))) AS PONTOS_PRES
    	  
    FROM GAT_PRESENCIAL_6 t1;

QUIT;


/***COLOCANDO A REGUA POR PREFIXO***/
/***COLOCANDO A REGUA POR PREFIXO***/
/***COLOCANDO A REGUA POR PREFIXO***/
/***COLOCANDO A REGUA POR PREFIXO***/


PROC SQL;

   CREATE TABLE PRES_SO_PREF AS SELECT

      t1.PREFIXO,      
	  t1.MCI,
	  t1.DIFERENCA
    	  
    FROM GAT_PRESENCIAL_4 t1
    ORDER BY 1, 2, 3;

QUIT;


PROC SQL;

   CREATE TABLE PRES_PAA_PREF AS SELECT

      input(t2.PREFAGENC, 4.) AS PREFIXO,      
	  t1.MCI,
      t1.DIFERENCA
    	  
    FROM GAT_PRESENCIAL_4 t1
	INNER JOIN IGR.IGRREDE_&ANOMES. t2 ON t1.PREFIXO = input(t2.PREFDEP, 4.)
	INNER JOIN ACORDO_PREFIXO_1 t3 ON input(t2.PREFAGENC, 4.) = t3.PREFIXO
	WHERE input(t2.PREFAGENC, 4.) <> 0
    ORDER BY 1, 2, 3;

QUIT;


PROC SQL;

CREATE TABLE TABELA_PRES_PREF_FINAL AS

   SELECT * FROM PRES_SO_PREF
   OUTER UNION CORR 
   SELECT * FROM PRES_PAA_PREF
   
   ;
Quit;


PROC STDIZE DATA=TABELA_PRES_PREF_FINAL OUT=TABELA_PRES_PREF_FINAL REPONLY MISSING=0;
	VAR _NUMERIC_;
QUIT;



/*O PAA FOI INCLUIDO*/



PROC SQL;

   CREATE TABLE GAT_PRESENCIAL_8 AS SELECT DISTINCT

      t1.PREFIXO AS PREFDEP,
	  AVG(t1.DIFERENCA) FORMAR 32.2 AS DIFERENCA_MEDIA
    	  
    FROM TABELA_PRES_PREF_FINAL t1
    GROUP BY 1;

QUIT;


DATA GAT_PRESENCIAL_8;
SET GAT_PRESENCIAL_8;
TipDepCnx = 2;
run;


PROC SQL;

   CREATE TABLE GAT_PRESENCIAL_9 AS SELECT DISTINCT

      t1.PREFDEP,
	  0 AS CTRA,
	  t1.TipDepCnx,
	  t1.DIFERENCA_MEDIA AS START_PRES,

      IFN(t1.DIFERENCA_MEDIA >= 40, 0, IFN(t1.DIFERENCA_MEDIA >= 35, 5, IFN(t1.DIFERENCA_MEDIA >= 30, 10, IFN(t1.DIFERENCA_MEDIA >= 25, 15, IFN(t1.DIFERENCA_MEDIA >= 20, 20, 25 ))))) AS PONTOS_PRES
    	  
    FROM GAT_PRESENCIAL_8 t1;

QUIT;


/***JUNTANDO***/


PROC SQL;

CREATE TABLE GAT_PRESENCIAL_10 AS
 
   SELECT * FROM GAT_PRESENCIAL_7
   OUTER UNION CORR
   SELECT * FROM GAT_PRESENCIAL_9
   ;

Quit;


PROC SQL;

   CREATE TABLE GAT_PRESENCIAL_10 AS SELECT DISTINCT

      *
    	  
   FROM GAT_PRESENCIAL_10
   ORDER BY 1,2 ;

QUIT;


/***COLOCANDO A REGUA NA HIERARQUIA***/
/***COLOCANDO A REGUA NA HIERARQUIA***/
/***COLOCANDO A REGUA NA HIERARQUIA***/
/***COLOCANDO A REGUA NA HIERARQUIA***/


PROC SQL;

   CREATE TABLE FC_FINAL_HIER AS SELECT DISTINCT

      t1.PREFIXO,
      t1.MCI, 
	  t1.DIFERENCA AS START_PRES,
	  t2.PREFSUPREG AS GEREV,
	  t2.PREFSUPEST AS SUPER,
	  t2.PREFUEN AS DIR,
	  8592 AS NOVADIR,
	  8166 AS VICE
	  
    FROM GAT_PRESENCIAL_4 t1
    INNER JOIN IGR.IGRREDE_&ANOMES. t2 ON t1.PREFIXO = input(t2.PREFDEP, 4.)
	GROUP BY 1;

QUIT;


/*GEREV*/
/*GEREV*/
/*GEREV*/
/*GEREV*/


PROC SQL;

   CREATE TABLE FC_FINAL_HIER_GEREV AS SELECT DISTINCT

      input(t1.GEREV, 4.) AS PREFDEP,
	  0 AS CTRA,
	  AVG(t1.START_PRES) FORMAR 32.2 AS START_MEDIO
    	  
    FROM FC_FINAL_HIER t1
    GROUP BY 1;

QUIT;


DATA FC_FINAL_HIER_GEREV;
SET FC_FINAL_HIER_GEREV;
TipDepCnx = 0;
run;


PROC SQL;

   CREATE TABLE FC_FINAL_HIER_GEREV_1 AS SELECT DISTINCT

      t1.PREFDEP,
	  t1.CTRA,
	  t1.TipDepCnx,
	  t1.START_MEDIO AS START_PRES,

      IFN(t1.START_MEDIO >= 40, 0, IFN(t1.START_MEDIO >= 35, 5, IFN(t1.START_MEDIO >= 30, 10, IFN(t1.START_MEDIO >= 25, 15, IFN(t1.START_MEDIO >= 20, 20, 25 ))))) AS PONTOS_PRES
    	  
    FROM FC_FINAL_HIER_GEREV t1
    ORDER BY 1,2;

QUIT;


/*SUPER*/
/*SUPER*/
/*SUPER*/
/*SUPER*/


PROC SQL;

   CREATE TABLE FC_FINAL_HIER_SUPER AS SELECT DISTINCT

      input(t1.SUPER, 4.) AS PREFDEP,
	  0 AS CTRA,
	  AVG(t1.START_PRES) FORMAR 32.2 AS START_MEDIO
    	  
    FROM FC_FINAL_HIER t1
    GROUP BY 1;

QUIT;


DATA FC_FINAL_HIER_SUPER;
SET FC_FINAL_HIER_SUPER;
TipDepCnx = 0;
run;


PROC SQL;

   CREATE TABLE FC_FINAL_HIER_SUPER_1 AS SELECT DISTINCT

      t1.PREFDEP,
	  t1.CTRA,
	  t1.TipDepCnx,
	  t1.START_MEDIO AS START_PRES,

      IFN(t1.START_MEDIO >= 40, 0, IFN(t1.START_MEDIO >= 35, 5, IFN(t1.START_MEDIO >= 30, 10, IFN(t1.START_MEDIO >= 25, 15, IFN(t1.START_MEDIO >= 20, 20, 25 ))))) AS PONTOS_PRES
    	  
    FROM FC_FINAL_HIER_SUPER t1
    ORDER BY 1,2;

QUIT;


/**DIR**/
/**DIR**/
/**DIR**/
/**DIR**/


PROC SQL;

   CREATE TABLE FC_FINAL_HIER_DIR AS SELECT DISTINCT

      input(t1.DIR, 4.) AS PREFDEP,
	  0 AS CTRA,
	  AVG(t1.START_PRES) FORMAR 32.2 AS START_MEDIO
    	  
    FROM FC_FINAL_HIER t1
    GROUP BY 1;

QUIT;


DATA FC_FINAL_HIER_DIR;
SET FC_FINAL_HIER_DIR;
TipDepCnx = 0;
run;


PROC SQL;

   CREATE TABLE FC_FINAL_HIER_DIR_1 AS SELECT DISTINCT

      t1.PREFDEP,
	  t1.CTRA,
	  t1.TipDepCnx,
	  t1.START_MEDIO AS START_PRES,

      IFN(t1.START_MEDIO >= 40, 0, IFN(t1.START_MEDIO >= 35, 5, IFN(t1.START_MEDIO >= 30, 10, IFN(t1.START_MEDIO >= 25, 15, IFN(t1.START_MEDIO >= 20, 20, 25 ))))) AS PONTOS_PRES
    	  
    FROM FC_FINAL_HIER_DIR t1
    ORDER BY 1,2;

QUIT;


/**NOVADIR**/
/**NOVADIR**/
/**NOVADIR**/
/**NOVADIR**/


PROC SQL;

   CREATE TABLE FC_FINAL_HIER_NOVADIR AS SELECT DISTINCT

      t1.NOVADIR AS PREFDEP,
	  0 AS CTRA,
	  AVG(t1.START_PRES) FORMAR 32.2 AS START_MEDIO
    	  
    FROM FC_FINAL_HIER t1
    GROUP BY 1;

QUIT;


DATA FC_FINAL_HIER_NOVADIR;
SET FC_FINAL_HIER_NOVADIR;
TipDepCnx = 0;
run;


PROC SQL;

   CREATE TABLE FC_FINAL_HIER_NOVADIR_1 AS SELECT DISTINCT

      t1.PREFDEP,
	  t1.CTRA,
	  t1.TipDepCnx,
	  t1.START_MEDIO AS START_PRES,

      IFN(t1.START_MEDIO >= 40, 0, IFN(t1.START_MEDIO >= 35, 5, IFN(t1.START_MEDIO >= 30, 10, IFN(t1.START_MEDIO >= 25, 15, IFN(t1.START_MEDIO >= 20, 20, 25 ))))) AS PONTOS_PRES
    	  
    FROM FC_FINAL_HIER_NOVADIR t1
    ORDER BY 1,2;

QUIT;


/**VICE**/
/**VICE**/
/**VICE**/
/**VICE**/


PROC SQL;

   CREATE TABLE FC_FINAL_HIER_VICE AS SELECT DISTINCT

      t1.VICE AS PREFDEP,
	  0 AS CTRA,
	  AVG(t1.START_PRES) FORMAR 32.2 AS START_MEDIO
    	  
    FROM FC_FINAL_HIER t1
    GROUP BY 1;

QUIT;


DATA FC_FINAL_HIER_VICE;
SET FC_FINAL_HIER_VICE;
TipDepCnx = 0;
run;


PROC SQL;

   CREATE TABLE FC_FINAL_HIER_VICE_1 AS SELECT DISTINCT

      t1.PREFDEP,
	  t1.CTRA,
	  t1.TipDepCnx,
	  t1.START_MEDIO AS START_PRES,

      IFN(t1.START_MEDIO >= 40, 0, IFN(t1.START_MEDIO >= 35, 5, IFN(t1.START_MEDIO >= 30, 10, IFN(t1.START_MEDIO >= 25, 15, IFN(t1.START_MEDIO >= 20, 20, 25 ))))) AS PONTOS_PRES
    	  
    FROM FC_FINAL_HIER_VICE t1
    ORDER BY 1,2;

QUIT;


/***JUNTANDO***/


PROC SQL;

CREATE TABLE GAT_PRESENCIAL_200 AS
 
   SELECT * FROM GAT_PRESENCIAL_10
   OUTER UNION CORR
   SELECT * FROM FC_FINAL_HIER_GEREV_1
   OUTER UNION CORR
   SELECT * FROM FC_FINAL_HIER_SUPER_1
   OUTER UNION CORR
   SELECT * FROM FC_FINAL_HIER_DIR_1
   OUTER UNION CORR
   SELECT * FROM FC_FINAL_HIER_NOVADIR_1
   OUTER UNION CORR
   SELECT * FROM FC_FINAL_HIER_VICE_1
   ;

Quit;


/*************GAT TELEFONICO**************/
/*************GAT TELEFONICO**************/
/*************GAT TELEFONICO**************/
/*************GAT TELEFONICO**************/


PROC SQL;
   CREATE TABLE GAT_TELEFONICO AS SELECT DISTINCT

      t1.MCI AS MCI,
	  t1.PREFIXO AS PREFIXO_PTL,
	  t1.PROTOCOLOATEND AS PTL,

      IFN((t1.DATAULTIMAANOTACAO IS MISSING), t1.DATASOLICITACAOATEND,
      IFN((t1.DATAULTIMAANOTACAO > t1.DATAINICIOATEND)
      OR (t1.DATAULTIMAANOTACAO = t1.DATAINICIOATEND AND t1.HORAULTIMAANOTACAO > HORAINICIOATEND), t1.DATAINICIOATEND, t1.DATAULTIMAANOTACAO))
	  FORMAT yymmdd10. AS DATA_ABERTURA,

      IFN((t1.HORAULTIMAANOTACAO IS MISSING), t1.HORASOLICITACAOATEND,
      IFN((t1.DATAULTIMAANOTACAO > t1.DATAINICIOATEND)
      OR (t1.DATAULTIMAANOTACAO = t1.DATAINICIOATEND AND t1.HORAULTIMAANOTACAO > HORAINICIOATEND), t1.HORAINICIOATEND, t1.HORAULTIMAANOTACAO))
	  FORMAT=TIME8. AS HMS_ABERTURA,     
      
	  t1.DATAINICIOATEND FORMAT yymmdd10. AS DATA_FECHAMENTO,
      t1.HORAINICIOATEND FORMAT=TIME8. AS HMS_FECHAMENTO
	   
   FROM TEL.TEL&ANOMES. t1
   WHERE t1.DATAINICIOATEND IS NOT MISSING AND t1.HORAINICIOATEND IS NOT MISSING AND t1.MCI <> 0;

QUIT;


PROC SQL;

      CREATE TABLE GAT_TELEFONICO_1 AS SELECT 

	  t1.MCI,
	  t1.PREFIXO_PTL,
	  t1.PTL,
	  t1.HMS_ABERTURA,
	  t1.HMS_FECHAMENTO,
	  t1.DATA_ABERTURA,
	  t1.DATA_FECHAMENTO,
	  WEEKDAY(t1.DATA_ABERTURA) AS D_SEM_ABERTURA,
	  WEEKDAY(t1.DATA_ABERTURA) AS D_SEM_FECHAMENTO
		  
      FROM GAT_TELEFONICO t1
      WHERE t1.DATA_FECHAMENTO <= &D1.;      

QUIT;


PROC SQL;

      CREATE TABLE GAT_TELEFONICO_2 AS SELECT 

	  t1.MCI,
	  t1.PREFIXO_PTL,
	  t1.PTL,
      t1.HMS_ABERTURA,
	  t1.HMS_FECHAMENTO,
	  t1.DATA_ABERTURA,
	  t1.DATA_FECHAMENTO,
	  t1.D_SEM_ABERTURA,
	  t1.D_SEM_FECHAMENTO,
	  (t1.DATA_FECHAMENTO - t1.DATA_ABERTURA) AS DIF_TEMP_1,
	  (t1.HMS_FECHAMENTO - t1.HMS_ABERTURA) FORMAT=TIME8. AS DIF_TEMP_2

      FROM GAT_TELEFONICO_1 t1;      

QUIT;


/********ENCARTEIRANDO*********/
/********ENCARTEIRANDO*********/
/********ENCARTEIRANDO*********/
/********ENCARTEIRANDO*********/


PROC SQL;

      CREATE TABLE GAT_TELEFONICO_3_ANT AS SELECT DISTINCT
      
	  t2.PREFIXO,
	  t2.CARTEIRA,
	  t1.PTL,
	  t1.PREFIXO_PTL,
	  t1.MCI,
      t1.HMS_ABERTURA,
	  t1.HMS_FECHAMENTO,
	  t1.DATA_ABERTURA,
	  t1.DATA_FECHAMENTO,
	  t1.D_SEM_ABERTURA,
	  t1.D_SEM_FECHAMENTO,
      t1.DIF_TEMP_1,
      t1.DIF_TEMP_2 
		  
      FROM GAT_TELEFONICO_2 t1
      LEFT JOIN CLIENTES t2 ON (t1.MCI = t2.MCI)
      ;      

QUIT;


PROC STDIZE DATA=GAT_TELEFONICO_3_ANT OUT=GAT_TELEFONICO_3_ANT REPONLY MISSING=0;
	VAR _NUMERIC_;
QUIT;


PROC SQL;

      CREATE TABLE GAT_TELEFONICO_3 AS SELECT DISTINCT
      
	  IFN(t1.PREFIXO_PTL = t1.PREFIXO, t1.PREFIXO, t1.PREFIXO_PTL) AS PREFIXO,
	  IFN(t1.PREFIXO_PTL <> t1.PREFIXO, 0, t1.CARTEIRA) AS CARTEIRA,
	  t1.PTL,
	  t1.PREFIXO_PTL,
	  t1.MCI,
      t1.HMS_ABERTURA,
	  t1.HMS_FECHAMENTO,
	  t1.DATA_ABERTURA,
	  t1.DATA_FECHAMENTO,
	  t1.D_SEM_ABERTURA,
	  t1.D_SEM_FECHAMENTO,
      t1.DIF_TEMP_1,
      t1.DIF_TEMP_2 
		  
      FROM GAT_TELEFONICO_3_ANT t1
      ;      

QUIT;


PROC STDIZE DATA=GAT_TELEFONICO_3 OUT=GAT_TELEFONICO_3 REPONLY MISSING=0;
	VAR _NUMERIC_;
QUIT;



/********TRATAMENTO FERIADO*********/
/********TRATAMENTO FERIADO*********/
/********TRATAMENTO FERIADO*********/
/********TRATAMENTO FERIADO*********/


/*********APLICANDO CORRECAO SAB E DOM**********/
/*********APLICANDO CORRECAO SAB E DOM**********/


PROC SQL;

   CREATE TABLE GAT_TELEFONICO_4 AS SELECT DISTINCT

      t1.PREFIXO,
	  t1.CARTEIRA,
	  t1.PTL,
	  t1.PREFIXO_PTL,
	  t1.MCI,
	  t1.HMS_ABERTURA,
	  t1.HMS_FECHAMENTO,
	  t1.DATA_ABERTURA,
	  t1.DATA_FECHAMENTO,
	  t1.D_SEM_ABERTURA,
	  t1.D_SEM_FECHAMENTO,

      IFN(t1.D_SEM_ABERTURA NOT IN (1,7), IFN(HOUR(t1.HMS_ABERTURA) > 17, IFN(t1.D_SEM_ABERTURA IN (2,3,4,5), t1.DATA_ABERTURA + 1, t1.DATA_ABERTURA + 3)
      , t1.DATA_ABERTURA), IFN(t1.D_SEM_ABERTURA IN (1), t1.DATA_ABERTURA + 1, t1.DATA_ABERTURA + 2)) FORMAT yymmdd10. AS DATA_ABERTURA_NOVO_1,
	  

      IFN(t1.D_SEM_ABERTURA NOT IN (1,7), IFN(HOUR(t1.HMS_ABERTURA) < 8 OR HOUR(t1.HMS_ABERTURA) > 17, "8:0:0"t, t1.HMS_ABERTURA), "8:0:0"t) FORMAT=TIME8. AS HMS_ABERTURA_NOVO_1,
  
      IFN(t1.D_SEM_FECHAMENTO NOT IN (1,7), IFN(HOUR(t1.HMS_FECHAMENTO) > 17, IFN(t1.D_SEM_FECHAMENTO IN (2,3,4,5), t1.DATA_FECHAMENTO + 1, t1.DATA_FECHAMENTO + 3)
      , t1.DATA_FECHAMENTO), IFN(t1.D_SEM_FECHAMENTO IN (1), t1.DATA_FECHAMENTO + 1, t1.DATA_FECHAMENTO + 2)) FORMAT yymmdd10. AS DATA_FECHAMENTO_NOVO_1,


      IFN(t1.D_SEM_FECHAMENTO NOT IN (1,7), IFN(HOUR(t1.HMS_FECHAMENTO) < 8 OR HOUR(t1.HMS_FECHAMENTO) > 17, "8:0:0"t, t1.HMS_FECHAMENTO), "8:0:0"t) FORMAT=TIME8. AS HMS_FECHAMENTO_NOVO_1
             

   FROM GAT_TELEFONICO_3 t1;

QUIT;


/*********APLICANDO CORRECAO FERIADO**********/
/*********APLICANDO CORRECAO FERIADO**********/


PROC SQL;

      CREATE TABLE GAT_TELEFONICO_5 AS SELECT 
      
	  t1.PREFIXO,
	  t1.CARTEIRA,
	  t1.PTL,
	  t1.PREFIXO_PTL,
	  t1.MCI,
      t1.HMS_Abertura,
	  t1.HMS_Fechamento,
	  t1.DATA_ABERTURA,
	  t1.DATA_FECHAMENTO,
	  t1.D_SEM_ABERTURA,
	  t1.D_SEM_FECHAMENTO,
	  t1.DATA_ABERTURA_NOVO_1,
	  t1.DATA_FECHAMENTO_NOVO_1,
	  t1.HMS_ABERTURA_NOVO_1,
	  t1.HMS_FECHAMENTO_NOVO_1,
	  t2.IND_FERIADO AS IND_FER_ABERT,
	  t3.IND_FERIADO AS IND_FER_FECH
	  
      FROM GAT_TELEFONICO_4 t1
      LEFT JOIN PREFIXO_FERIADO_1 t2 ON (t1.PREFIXO = t2.PREFIXO AND t1.DATA_ABERTURA_NOVO_1 = t2.DT_FER)
	  LEFT JOIN PREFIXO_FERIADO_1 t3 ON (t1.PREFIXO = t3.PREFIXO AND t1.DATA_FECHAMENTO_NOVO_1 = t3.DT_FER)
      GROUP BY 1,2,3;      

QUIT;


PROC STDIZE OUT=GAT_TELEFONICO_5 REPONLY MISSING=0;
	VAR _NUMERIC_;
QUIT;


PROC SQL;

      CREATE TABLE GAT_TELEFONICO_6 AS SELECT 
      
	  t1.PREFIXO,
	  t1.CARTEIRA,
	  t1.PTL,
	  t1.PREFIXO_PTL,
	  t1.MCI,
	  t1.HMS_ABERTURA,
	  t1.HMS_FECHAMENTO,
	  t1.DATA_ABERTURA,
	  t1.DATA_FECHAMENTO,
	  t1.D_SEM_ABERTURA,
	  t1.D_SEM_FECHAMENTO,
	  t1.DATA_ABERTURA_NOVO_1,
	  t1.DATA_FECHAMENTO_NOVO_1,
	  t1.HMS_ABERTURA_NOVO_1,
	  t1.HMS_FECHAMENTO_NOVO_1,
	  t1.IND_FER_ABERT,
	  t1.IND_FER_FECH,

      IFN(DATA_ABERTURA_NOVO_1 = '04JUL2019'd, DATA_ABERTURA_NOVO_1 + 2, 
      IFN(IND_FER_ABERT = 1, 
      IFN(WEEKDAY(DATA_ABERTURA_NOVO_1) = 6, DATA_ABERTURA_NOVO_1 + 3, 
      IFN(WEEKDAY(DATA_ABERTURA_NOVO_1) = 7, DATA_ABERTURA_NOVO_1 + 2, DATA_ABERTURA_NOVO_1 + 1)), DATA_ABERTURA_NOVO_1)) FORMAT yymmdd10. AS DATA_ABERTURA_NOVO_2,
      IFN(DATA_ABERTURA_NOVO_1 = '06MAR2019'd, "12:0:0"t, IFN(IND_FER_ABERT = 1, "8:0:0"t, HMS_ABERTURA_NOVO_1)) FORMAT = TIME8. AS HMS_ABERTURA_NOVO_2,
	  

      IFN(DATA_FECHAMENTO_NOVO_1 = '04JUL2019'd, DATA_FECHAMENTO_NOVO_1 + 2, 
      IFN(IND_FER_FECH = 1, 
      IFN(WEEKDAY(DATA_FECHAMENTO_NOVO_1) = 6, DATA_FECHAMENTO_NOVO_1 + 3, 
      IFN(WEEKDAY(DATA_FECHAMENTO_NOVO_1) = 7, DATA_FECHAMENTO_NOVO_1 + 2, DATA_FECHAMENTO_NOVO_1 + 1)), DATA_FECHAMENTO_NOVO_1)) FORMAT yymmdd10. AS DATA_FECHAMENTO_NOVO_2,
	  IFN(DATA_FECHAMENTO_NOVO_1 = '06MAR2019'd, "12:0:0"t, IFN(IND_FER_FECH = 1, "8:0:0"t, HMS_FECHAMENTO_NOVO_1)) FORMAT = TIME8. AS HMS_FECHAMENTO_NOVO_2
		  
      FROM GAT_TELEFONICO_5 t1;      

QUIT;


/*********APLICANDO CORRECAO FERIADO PELA SEGUNDA VEZ**********/
/*********APLICANDO CORRECAO FERIADO PELA SEGUNDA VEZ**********/


PROC SQL;

      CREATE TABLE GAT_TELEFONICO_7 AS SELECT 
      
	  t1.PREFIXO,
	  t1.CARTEIRA,
	  t1.PTL,
	  t1.PREFIXO_PTL,
	  t1.MCI,
      t1.HMS_Abertura,
	  t1.HMS_Fechamento,
	  t1.DATA_ABERTURA,
	  t1.DATA_FECHAMENTO,
	  t1.D_SEM_ABERTURA,
	  t1.D_SEM_FECHAMENTO,
	  t1.DATA_ABERTURA_NOVO_1,
	  t1.DATA_FECHAMENTO_NOVO_1,
	  t1.HMS_ABERTURA_NOVO_1,
	  t1.HMS_FECHAMENTO_NOVO_1,
	  t1.DATA_ABERTURA_NOVO_2,
	  t1.DATA_FECHAMENTO_NOVO_2,
	  t1.HMS_ABERTURA_NOVO_2,
	  t1.HMS_FECHAMENTO_NOVO_2,
	  t2.IND_FERIADO AS IND_FER_ABERT,
	  t3.IND_FERIADO AS IND_FER_FECH
	  
      FROM GAT_TELEFONICO_6 t1
      LEFT JOIN PREFIXO_FERIADO_1 t2 ON (t1.PREFIXO = t2.PREFIXO AND t1.DATA_ABERTURA_NOVO_2 = t2.DT_FER)
	  LEFT JOIN PREFIXO_FERIADO_1 t3 ON (t1.PREFIXO = t3.PREFIXO AND t1.DATA_FECHAMENTO_NOVO_2 = t3.DT_FER)
      GROUP BY 1,2,3;      

QUIT;


PROC STDIZE OUT=GAT_TELEFONICO_7 REPONLY MISSING=0;
	VAR _NUMERIC_;
QUIT;


PROC SQL;

      CREATE TABLE GAT_TELEFONICO_8 AS SELECT 
      
	  t1.PREFIXO,
	  t1.CARTEIRA,
	  t1.PTL,
	  t1.PREFIXO_PTL,
	  t1.MCI,
      t1.HMS_ABERTURA,
	  t1.HMS_FECHAMENTO,
	  t1.DATA_ABERTURA,
	  t1.DATA_FECHAMENTO,
	  t1.D_SEM_ABERTURA,
	  t1.D_SEM_FECHAMENTO,
	  t1.DATA_ABERTURA_NOVO_1,
	  t1.DATA_FECHAMENTO_NOVO_1,
	  t1.HMS_ABERTURA_NOVO_1,
	  t1.HMS_FECHAMENTO_NOVO_1,
	  t1.DATA_ABERTURA_NOVO_2,
	  t1.DATA_FECHAMENTO_NOVO_2,
	  t1.HMS_ABERTURA_NOVO_2,
	  t1.HMS_FECHAMENTO_NOVO_2,
	  t1.IND_FER_ABERT,
	  t1.IND_FER_FECH,

      IFN(DATA_ABERTURA_NOVO_2 = '04JUL2019'd, DATA_ABERTURA_NOVO_2 + 2, 
      IFN(IND_FER_ABERT = 1, 
      IFN(WEEKDAY(DATA_ABERTURA_NOVO_2) = 6, DATA_ABERTURA_NOVO_2 + 3, 
      IFN(WEEKDAY(DATA_ABERTURA_NOVO_2) = 7, DATA_ABERTURA_NOVO_2 + 2, DATA_ABERTURA_NOVO_2 + 1)), DATA_ABERTURA_NOVO_2)) FORMAT yymmdd10. AS DATA_ABERTURA_NOVO_3,

      IFN(DATA_ABERTURA_NOVO_2 = '06MAR2019'd, "12:0:0"t, IFN(IND_FER_ABERT = 1, "8:0:0"t, HMS_ABERTURA_NOVO_2)) FORMAT = TIME8. AS HMS_ABERTURA_NOVO_3,
	  
      IFN(DATA_FECHAMENTO_NOVO_2 = '04JUL2019'd, DATA_FECHAMENTO_NOVO_2 + 2, 
      IFN(IND_FER_FECH = 1, 
      IFN(WEEKDAY(DATA_FECHAMENTO_NOVO_2) = 6, DATA_FECHAMENTO_NOVO_2 + 3, 
      IFN(WEEKDAY(DATA_FECHAMENTO_NOVO_2) = 7, DATA_FECHAMENTO_NOVO_2 + 2, DATA_FECHAMENTO_NOVO_2 + 1)), DATA_FECHAMENTO_NOVO_2)) FORMAT yymmdd10. AS DATA_FECHAMENTO_NOVO_3,

	  IFN(DATA_FECHAMENTO_NOVO_2 = '06MAR2019'd, "12:0:0"t, IFN(IND_FER_FECH = 1, "8:0:0"t, HMS_FECHAMENTO_NOVO_2)) FORMAT = TIME8. AS HMS_FECHAMENTO_NOVO_3
		  
      FROM GAT_TELEFONICO_7 t1;      

QUIT;



/*********APLICANDO CORRECAO FERIADO PELA TERCEIRA VEZ**********/
/*********APLICANDO CORRECAO FERIADO PELA TERCEIRA VEZ**********/


PROC SQL;

      CREATE TABLE GAT_TELEFONICO_9 AS SELECT 
      
	  t1.PREFIXO,
	  t1.CARTEIRA,
	  t1.PTL,
	  t1.PREFIXO_PTL,
	  t1.MCI,
      t1.HMS_Abertura,
	  t1.HMS_Fechamento,
	  t1.DATA_ABERTURA,
	  t1.DATA_FECHAMENTO,
	  t1.D_SEM_ABERTURA,
	  t1.D_SEM_FECHAMENTO,
	  t1.DATA_ABERTURA_NOVO_1,
	  t1.DATA_FECHAMENTO_NOVO_1,
	  t1.HMS_ABERTURA_NOVO_1,
	  t1.HMS_FECHAMENTO_NOVO_1,
	  t1.DATA_ABERTURA_NOVO_2,
	  t1.DATA_FECHAMENTO_NOVO_2,
	  t1.HMS_ABERTURA_NOVO_2,
	  t1.HMS_FECHAMENTO_NOVO_2,
	  t1.DATA_ABERTURA_NOVO_3,
	  t1.DATA_FECHAMENTO_NOVO_3,
	  t1.HMS_ABERTURA_NOVO_3,
	  t1.HMS_FECHAMENTO_NOVO_3,
	  t2.IND_FERIADO AS IND_FER_ABERT,
	  t3.IND_FERIADO AS IND_FER_FECH
	  
      FROM GAT_TELEFONICO_8 t1
      LEFT JOIN PREFIXO_FERIADO_1 t2 ON (t1.PREFIXO = t2.PREFIXO AND t1.DATA_ABERTURA_NOVO_3 = t2.DT_FER)
	  LEFT JOIN PREFIXO_FERIADO_1 t3 ON (t1.PREFIXO = t3.PREFIXO AND t1.DATA_FECHAMENTO_NOVO_3 = t3.DT_FER)
      GROUP BY 1,2,3;      

QUIT;


PROC STDIZE OUT=GAT_TELEFONICO_9 REPONLY MISSING=0;
	VAR _NUMERIC_;
QUIT;


PROC SQL;

      CREATE TABLE GAT_TELEFONICO_10 AS SELECT 
      
	  t1.PREFIXO,
	  t1.CARTEIRA,
	  t1.PTL,
	  t1.PREFIXO_PTL,
	  t1.MCI,
      t1.HMS_ABERTURA,
	  t1.HMS_FECHAMENTO,
	  t1.DATA_ABERTURA,
	  t1.DATA_FECHAMENTO,
	  t1.D_SEM_ABERTURA,
	  t1.D_SEM_FECHAMENTO,
	  t1.DATA_ABERTURA_NOVO_1,
	  t1.DATA_FECHAMENTO_NOVO_1,
	  t1.HMS_ABERTURA_NOVO_1,
	  t1.HMS_FECHAMENTO_NOVO_1,
	  t1.DATA_ABERTURA_NOVO_2,
	  t1.DATA_FECHAMENTO_NOVO_2,
	  t1.HMS_ABERTURA_NOVO_2,
	  t1.HMS_FECHAMENTO_NOVO_2,
	  t1.DATA_ABERTURA_NOVO_3,
	  t1.DATA_FECHAMENTO_NOVO_3,
	  t1.HMS_ABERTURA_NOVO_3,
	  t1.HMS_FECHAMENTO_NOVO_3,
	  t1.IND_FER_ABERT,
	  t1.IND_FER_FECH,

      IFN(DATA_ABERTURA_NOVO_3 = '04JUL2019'd, DATA_ABERTURA_NOVO_3 + 2, 
      IFN(IND_FER_ABERT = 1, 
      IFN(WEEKDAY(DATA_ABERTURA_NOVO_3) = 6, DATA_ABERTURA_NOVO_3 + 3, 
      IFN(WEEKDAY(DATA_ABERTURA_NOVO_3) = 7, DATA_ABERTURA_NOVO_3 + 2, DATA_ABERTURA_NOVO_3 + 1)), DATA_ABERTURA_NOVO_3)) FORMAT yymmdd10. AS DATA_ABERTURA_NOVO_ULT,

      IFN(DATA_ABERTURA_NOVO_3 = '06MAR2019'd, "12:0:0"t, IFN(IND_FER_ABERT = 1, "8:0:0"t, HMS_ABERTURA_NOVO_3)) FORMAT = TIME8. AS HMS_ABERTURA_NOVO_ULT,
	  
      IFN(DATA_FECHAMENTO_NOVO_3 = '04JUL2019'd, DATA_FECHAMENTO_NOVO_3 + 2, 
      IFN(IND_FER_FECH = 1, 
      IFN(WEEKDAY(DATA_FECHAMENTO_NOVO_3) = 6, DATA_FECHAMENTO_NOVO_3 + 3, 
      IFN(WEEKDAY(DATA_FECHAMENTO_NOVO_3) = 7, DATA_FECHAMENTO_NOVO_3 + 2, DATA_FECHAMENTO_NOVO_3 + 1)), DATA_FECHAMENTO_NOVO_3)) FORMAT yymmdd10. AS DATA_FECHAMENTO_NOVO_ULT,

	  IFN(DATA_FECHAMENTO_NOVO_3 = '06MAR2019'd, "12:0:0"t, IFN(IND_FER_FECH = 1, "8:0:0"t, HMS_FECHAMENTO_NOVO_3)) FORMAT = TIME8. AS HMS_FECHAMENTO_NOVO_ULT
		  
      FROM GAT_TELEFONICO_9 t1;      

QUIT;



/********CALCULO TEMPO*********/
/********CALCULO TEMPO*********/
/********CALCULO TEMPO*********/
/********CALCULO TEMPO*********/


PROC SQL;

   CREATE TABLE GAT_TELEFONICO_11 AS SELECT DISTINCT

      t1.PREFIXO,
	  t1.CARTEIRA,
	  t1.PTL,
	  t1.PREFIXO_PTL,
	  t1.MCI,
	  t1.DATA_ABERTURA,
	  t1.DATA_FECHAMENTO,
	  t1.HMS_ABERTURA,
	  t1.HMS_FECHAMENTO,
	  t1.DATA_ABERTURA_NOVO_ULT,
	  t1.DATA_FECHAMENTO_NOVO_ULT,
	  t1.HMS_ABERTURA_NOVO_ULT,
	  t1.HMS_FECHAMENTO_NOVO_ULT,

      (t1.DATA_FECHAMENTO_NOVO_ULT - t1.DATA_ABERTURA_NOVO_ULT) AS DIF_TEMP_1,
	  (t1.HMS_FECHAMENTO_NOVO_ULT - t1.HMS_ABERTURA_NOVO_ULT) FORMAT = TIME8. AS DIF_TEMP_2 

	      
      FROM GAT_TELEFONICO_10 t1;

QUIT;


/***TIRAMOS OS FERIADOS DA CONTAGEM DE DIAS***/
/***TIRAMOS OS FERIADOS DA CONTAGEM DE DIAS***/


PROC SQL;

   CREATE TABLE GAT_TELEFONICO_CORRECAO AS SELECT DISTINCT

      t1.PREFIXO, t2.DT_FER, t1.DATA_ABERTURA_NOVO_ULT, t1.DATA_FECHAMENTO_NOVO_ULT
	  	      
      FROM GAT_TELEFONICO_11 t1
      INNER JOIN JUNTANDO_FINAL t2 ON t1.PREFIXO = t2.PREFIXO
      WHERE DT_FER > t1.DATA_ABERTURA_NOVO_ULT AND DT_FER < t1.DATA_FECHAMENTO_NOVO_ULT;

QUIT;


PROC SQL;

   CREATE TABLE GAT_TELEFONICO_CORRECAO_2 AS SELECT DISTINCT

      t1.PREFIXO, t1.DATA_ABERTURA_NOVO_ULT, t1.DATA_FECHAMENTO_NOVO_ULT, COUNT(DT_FER) AS CONTAGEM
	  	      
   FROM GAT_TELEFONICO_CORRECAO t1
   GROUP BY 1, 2, 3;

QUIT;


PROC SQL;

   CREATE TABLE GAT_TELEFONICO_CORRECAO_3 AS SELECT DISTINCT

      t1.PREFIXO,
	  t1.CARTEIRA,
	  t1.PTL,
	  t1.MCI,
	  t1.DATA_ABERTURA,
	  t1.DATA_FECHAMENTO,
	  t1.HMS_ABERTURA,
	  t1.HMS_FECHAMENTO,
	  t1.DATA_ABERTURA_NOVO_ULT,
	  t1.DATA_FECHAMENTO_NOVO_ULT,
	  t1.HMS_ABERTURA_NOVO_ULT,
	  t1.HMS_FECHAMENTO_NOVO_ULT, 
      t1.DIF_TEMP_1, 
      t1.DIF_TEMP_2,  
      t2.CONTAGEM,
      t1.PREFIXO_PTL 
	      
      FROM GAT_TELEFONICO_11 t1

   LEFT JOIN GAT_TELEFONICO_CORRECAO_2 t2 ON t1.PREFIXO = t2.PREFIXO AND t1.DATA_ABERTURA_NOVO_ULT = t2.DATA_ABERTURA_NOVO_ULT AND t1.DATA_FECHAMENTO_NOVO_ULT = t2.DATA_FECHAMENTO_NOVO_ULT
   GROUP BY 1,2,3;

QUIT;


PROC STDIZE DATA=GAT_TELEFONICO_CORRECAO_3 OUT=GAT_TELEFONICO_CORRECAO_3 REPONLY MISSING=0;
	VAR _NUMERIC_;
QUIT;


PROC SQL;

   CREATE TABLE GAT_TELEFONICO_11_CORRIGIDO AS SELECT DISTINCT

      t1.PREFIXO,
	  t1.CARTEIRA,
	  t1.PTL,
	  t1.MCI,
	  t1.DATA_ABERTURA,
	  t1.DATA_FECHAMENTO,
	  t1.HMS_ABERTURA,
	  t1.HMS_FECHAMENTO,
	  t1.DATA_ABERTURA_NOVO_ULT,
	  t1.DATA_FECHAMENTO_NOVO_ULT,
	  t1.HMS_ABERTURA_NOVO_ULT,
	  t1.HMS_FECHAMENTO_NOVO_ULT,
      (t1.DIF_TEMP_1 - t1.CONTAGEM) AS DIF_TEMP_1,
	  t1.DIF_TEMP_2,
      t1.PREFIXO_PTL 
	      
      FROM GAT_TELEFONICO_CORRECAO_3 t1;

QUIT;


/***CALCULANDO***/
/***CALCULANDO***/

 
PROC SQL;

   CREATE TABLE GAT_TELEFONICO_12_CORRIGIDO AS SELECT DISTINCT

      t1.PREFIXO,
	  t1.CARTEIRA,
	  t1.PTL,
	  t1.MCI,
	  t1.DATA_ABERTURA,
	  t1.DATA_FECHAMENTO,
	  t1.HMS_ABERTURA,
	  t1.HMS_FECHAMENTO,
	  t1.DATA_ABERTURA_NOVO_ULT,
	  t1.DATA_FECHAMENTO_NOVO_ULT,
	  t1.HMS_ABERTURA_NOVO_ULT,
	  t1.HMS_FECHAMENTO_NOVO_ULT,
	  t1.DIF_TEMP_1,
	  t1.DIF_TEMP_2,
      
	  DIF_TEMP_1*600 AS DIF_TEMP_1_NOVO,	 
 


      IFN(t1.DIF_TEMP_2 = "0:00:00"t, 0,

	  IFN(t1.DIF_TEMP_2 >  "0:00:00"t, ((HOUR(t1.DIF_TEMP_2)*60) + MINUTE(t1.DIF_TEMP_2)), 
      (-1*((23 - HOUR(t1.DIF_TEMP_2))*60) -1*(59 - MINUTE(t1.DIF_TEMP_2))))

      )

      AS DIF_TEMP_2_NOVO,

	  t1.PREFIXO_PTL
	  	       
      FROM GAT_TELEFONICO_11_CORRIGIDO t1;

QUIT;


PROC SQL;

   CREATE TABLE GAT_TELEFONICO_13_CORRIGIDO AS SELECT DISTINCT

      t1.PREFIXO,
	  t1.CARTEIRA,
	  t1.PTL,
	  t1.MCI,
	  t1.DATA_ABERTURA,
	  t1.DATA_FECHAMENTO,
	  t1.HMS_ABERTURA,
	  t1.HMS_FECHAMENTO,
	  t1.DATA_ABERTURA_NOVO_ULT,
	  t1.DATA_FECHAMENTO_NOVO_ULT,
	  t1.HMS_ABERTURA_NOVO_ULT,
	  t1.HMS_FECHAMENTO_NOVO_ULT,
	  (t1.DIF_TEMP_1_NOVO + t1.DIF_TEMP_2_NOVO) AS START,
	  t1.PREFIXO_PTL
	  
    FROM GAT_TELEFONICO_12_CORRIGIDO t1
    INNER JOIN ACORDO_PREFIXO_1 t2 ON t1.PREFIXO = t2.PREFIXO;

QUIT;


PROC SQL;

   CREATE TABLE LEVANTAMENTO_TEL AS SELECT DISTINCT

      t1.PREFIXO,
	  t1.CARTEIRA,
	  t1.MCI,
	  t1.DATA_ABERTURA,
	  t1.DATA_FECHAMENTO,
	  t1.HMS_ABERTURA,
	  t1.HMS_FECHAMENTO,
	  t1.DATA_ABERTURA_NOVO_ULT AS DATA_ABERTURA_CORRIGIDO,
	  t1.DATA_FECHAMENTO_NOVO_ULT AS DATA_FECHAMENTO_CORRIGIDO,
	  t1.HMS_ABERTURA_NOVO_ULT AS HMS_ABERTURA_CORRIGIDO,
	  t1.HMS_FECHAMENTO_NOVO_ULT AS HMS_FECHAMENTO_CORRIGIDO,
	  t1.START AS DIFERENCA,
	  t1.PREFIXO_PTL

    FROM GAT_TELEFONICO_13_CORRIGIDO t1

    WHERE PREFIXO IN (1881);

QUIT;


/***COLOCANDO A REGUA POR CARTEIRA***/
/***COLOCANDO A REGUA POR CARTEIRA***/
/***COLOCANDO A REGUA POR CARTEIRA***/
/***COLOCANDO A REGUA POR CARTEIRA***/


PROC SQL;

   CREATE TABLE GAT_TELEFONICO_20 AS SELECT DISTINCT

      t1.PREFIXO AS PREFDEP,
	  t1.CARTEIRA AS CTRA,
	  AVG(t1.START) FORMAR 32.2 AS START_MEDIO
    	  
    FROM GAT_TELEFONICO_13_CORRIGIDO t1
	WHERE t1.CARTEIRA <> 0
    GROUP BY 1,2;

QUIT;


DATA GAT_TELEFONICO_20;
SET GAT_TELEFONICO_20;
TipDepCnx = 1;
run;


PROC SQL;

   CREATE TABLE GAT_TELEFONICO_21 AS SELECT DISTINCT

      t1.PREFDEP,
	  t1.CTRA,
	  t1.TipDepCnx,
	  t1.START_MEDIO AS START_TEL,

      IFN(START_MEDIO >= 120, 0, IFN(START_MEDIO >= 105, 5, IFN(START_MEDIO >= 90, 10, IFN(START_MEDIO >= 75, 15, IFN(START_MEDIO >= 60, 20, 25 ))))) AS PONTOS_GATTEL
    	  
    FROM GAT_TELEFONICO_20 t1;

QUIT;


/***COLOCANDO A REGUA POR PREFIXO***/
/***COLOCANDO A REGUA POR PREFIXO***/
/***COLOCANDO A REGUA POR PREFIXO***/
/***COLOCANDO A REGUA POR PREFIXO***/


PROC SQL;

   CREATE TABLE TEL_SO_PREF AS SELECT

      t1.PREFIXO,      
	  t1.MCI,
	  t1.START
    	  
    FROM GAT_TELEFONICO_13_CORRIGIDO t1
    ORDER BY 1, 2, 3;

QUIT;


PROC SQL;

   CREATE TABLE TEL_PAA_PREF AS SELECT

      input(t2.PREFAGENC, 4.) AS PREFIXO,      
	  t1.MCI,
      t1.START
    	  
    FROM GAT_TELEFONICO_13_CORRIGIDO t1
	INNER JOIN IGR.IGRREDE_&ANOMES. t2 ON t1.PREFIXO = input(t2.PREFDEP, 4.)
	INNER JOIN ACORDO_PREFIXO_1 t3 ON input(t2.PREFAGENC, 4.) = t3.PREFIXO
	WHERE input(t2.PREFAGENC, 4.) <> 0
    ORDER BY 1, 2, 3;

QUIT;


PROC SQL;

CREATE TABLE TABELA_TEL_PREF_FINAL AS

   SELECT * FROM TEL_SO_PREF
   OUTER UNION CORR 
   SELECT * FROM TEL_PAA_PREF
   
   ;
Quit;


PROC STDIZE DATA=TABELA_TEL_PREF_FINAL OUT=TABELA_TEL_PREF_FINAL REPONLY MISSING=0;
	VAR _NUMERIC_;
QUIT;


/*O PAA FOI INCLUIDO*/

PROC SQL;

   CREATE TABLE GAT_TELEFONICO_22 AS SELECT DISTINCT

      t1.PREFIXO AS PREFDEP,
	  AVG(t1.START) FORMAR 32.2 AS START_MEDIO
    	  
    FROM GAT_TELEFONICO_13_CORRIGIDO t1
    GROUP BY 1;

QUIT;


DATA GAT_TELEFONICO_22;
SET GAT_TELEFONICO_22;
TipDepCnx = 2;
run;


PROC SQL;

   CREATE TABLE GAT_TELEFONICO_23 AS SELECT DISTINCT

      t1.PREFDEP,
	  0 AS CTRA,
	  t1.TipDepCnx,
	  t1.START_MEDIO AS START_TEL,

      IFN(START_MEDIO >= 120, 0, IFN(START_MEDIO >= 105, 5, IFN(START_MEDIO >= 90, 10, IFN(START_MEDIO >= 75, 15, IFN(START_MEDIO >= 60, 20, 25 ))))) AS PONTOS_GATTEL
    	  
    FROM GAT_TELEFONICO_22 t1;

QUIT;


/***JUNTANDO***/


PROC SQL;

CREATE TABLE GAT_TELEFONICO_24 AS
 
   SELECT * FROM GAT_TELEFONICO_21
   OUTER UNION CORR
   SELECT * FROM GAT_TELEFONICO_23
   ;

Quit;


PROC SQL;

   CREATE TABLE GAT_TELEFONICO_25 AS SELECT DISTINCT *
          	  
   FROM GAT_TELEFONICO_24
   ORDER BY 1,2 ;

QUIT;


/***COLOCANDO A REGUA NA HIERARQUIA***/
/***COLOCANDO A REGUA NA HIERARQUIA***/
/***COLOCANDO A REGUA NA HIERARQUIA***/
/***COLOCANDO A REGUA NA HIERARQUIA***/


PROC SQL;

   CREATE TABLE FC_FINAL_HIER AS SELECT DISTINCT

      t1.PREFIXO,
      t1.MCI, 
	  t1.START AS START_TEL,
	  t2.PREFSUPREG AS GEREV,
	  t2.PREFSUPEST AS SUPER,
	  t2.PREFUEN AS DIR,
	  8592 AS NOVADIR,
	  8166 AS VICE
	  
    FROM GAT_TELEFONICO_13_CORRIGIDO t1
    INNER JOIN IGR.IGRREDE_&ANOMES. t2 ON t1.PREFIXO = input(t2.PREFDEP, 4.)
	GROUP BY 1;

QUIT;


/*GEREV*/
/*GEREV*/
/*GEREV*/
/*GEREV*/


PROC SQL;

   CREATE TABLE FC_FINAL_HIER_GEREV AS SELECT DISTINCT

      input(t1.GEREV, 4.) AS PREFDEP,
	  0 AS CTRA,
	  AVG(t1.START_TEL) FORMAR 32.2 AS START_MEDIO
    	  
    FROM FC_FINAL_HIER t1
    GROUP BY 1;

QUIT;


DATA FC_FINAL_HIER_GEREV;
SET FC_FINAL_HIER_GEREV;
TipDepCnx = 0;
run;


PROC SQL;

   CREATE TABLE FC_FINAL_HIER_GEREV_1 AS SELECT DISTINCT

      t1.PREFDEP,
	  t1.CTRA,
	  t1.TipDepCnx,
	  t1.START_MEDIO AS START_TEL,

      IFN(START_MEDIO >= 120, 0, IFN(START_MEDIO >= 105, 5, IFN(START_MEDIO >= 90, 10, IFN(START_MEDIO >= 75, 15, IFN(START_MEDIO >= 60, 20, 25 ))))) AS PONTOS_GATTEL
	      	  
    FROM FC_FINAL_HIER_GEREV t1
    ORDER BY 1,2;

QUIT;


/*SUPER*/
/*SUPER*/
/*SUPER*/
/*SUPER*/


PROC SQL;

   CREATE TABLE FC_FINAL_HIER_SUPER AS SELECT DISTINCT

      input(t1.SUPER, 4.) AS PREFDEP,
	  0 AS CTRA,
	  AVG(t1.START_TEL) FORMAR 32.2 AS START_MEDIO
    	  
    FROM FC_FINAL_HIER t1
    GROUP BY 1;

QUIT;


DATA FC_FINAL_HIER_SUPER;
SET FC_FINAL_HIER_SUPER;
TipDepCnx = 0;
run;


PROC SQL;

   CREATE TABLE FC_FINAL_HIER_SUPER_1 AS SELECT DISTINCT

      t1.PREFDEP,
	  t1.CTRA,
	  t1.TipDepCnx,
	  t1.START_MEDIO AS START_TEL,

      IFN(START_MEDIO >= 120, 0, IFN(START_MEDIO >= 105, 5, IFN(START_MEDIO >= 90, 10, IFN(START_MEDIO >= 75, 15, IFN(START_MEDIO >= 60, 20, 25 ))))) AS PONTOS_GATTEL
    	  
    FROM FC_FINAL_HIER_SUPER t1
    ORDER BY 1,2;

QUIT;


/**DIR**/
/**DIR**/
/**DIR**/
/**DIR**/


PROC SQL;

   CREATE TABLE FC_FINAL_HIER_DIR AS SELECT DISTINCT

      input(t1.DIR, 4.) AS PREFDEP,
	  0 AS CTRA,
	  AVG(t1.START_TEL) FORMAR 32.2 AS START_MEDIO
    	  
    FROM FC_FINAL_HIER t1
    GROUP BY 1;

QUIT;


DATA FC_FINAL_HIER_DIR;
SET FC_FINAL_HIER_DIR;
TipDepCnx = 0;
run;


PROC SQL;

   CREATE TABLE FC_FINAL_HIER_DIR_1 AS SELECT DISTINCT

      t1.PREFDEP,
	  t1.CTRA,
	  t1.TipDepCnx,
	  t1.START_MEDIO AS START_TEL,

      IFN(START_MEDIO >= 120, 0, IFN(START_MEDIO >= 105, 5, IFN(START_MEDIO >= 90, 10, IFN(START_MEDIO >= 75, 15, IFN(START_MEDIO >= 60, 20, 25 ))))) AS PONTOS_GATTEL
    	  
    FROM FC_FINAL_HIER_DIR t1
    ORDER BY 1,2;

QUIT;


/**NOVADIR**/
/**NOVADIR**/
/**NOVADIR**/
/**NOVADIR**/


PROC SQL;

   CREATE TABLE FC_FINAL_HIER_NOVADIR AS SELECT DISTINCT

      t1.NOVADIR AS PREFDEP,
	  0 AS CTRA,
	  AVG(t1.START_TEL) FORMAR 32.2 AS START_MEDIO
    	  
    FROM FC_FINAL_HIER t1
    GROUP BY 1;

QUIT;


DATA FC_FINAL_HIER_NOVADIR;
SET FC_FINAL_HIER_NOVADIR;
TipDepCnx = 0;
run;


PROC SQL;

   CREATE TABLE FC_FINAL_HIER_NOVADIR_1 AS SELECT DISTINCT

      t1.PREFDEP,
	  t1.CTRA,
	  t1.TipDepCnx,
	  t1.START_MEDIO AS START_TEL,

      IFN(START_MEDIO >= 120, 0, IFN(START_MEDIO >= 105, 5, IFN(START_MEDIO >= 90, 10, IFN(START_MEDIO >= 75, 15, IFN(START_MEDIO >= 60, 20, 25 ))))) AS PONTOS_GATTEL
    	  
    FROM FC_FINAL_HIER_NOVADIR t1
    ORDER BY 1,2;

QUIT;


/**VICE**/
/**VICE**/
/**VICE**/
/**VICE**/


PROC SQL;

   CREATE TABLE FC_FINAL_HIER_VICE AS SELECT DISTINCT

      t1.VICE AS PREFDEP,
	  0 AS CTRA,
	  AVG(t1.START_TEL) FORMAR 32.2 AS START_MEDIO
    	  
    FROM FC_FINAL_HIER t1
    GROUP BY 1;

QUIT;


DATA FC_FINAL_HIER_VICE;
SET FC_FINAL_HIER_VICE;
TipDepCnx = 0;
run;


PROC SQL;

   CREATE TABLE FC_FINAL_HIER_VICE_1 AS SELECT DISTINCT

      t1.PREFDEP,
	  t1.CTRA,
	  t1.TipDepCnx,
	  t1.START_MEDIO AS START_TEL,

      IFN(START_MEDIO >= 120, 0, IFN(START_MEDIO >= 105, 5, IFN(START_MEDIO >= 90, 10, IFN(START_MEDIO >= 75, 15, IFN(START_MEDIO >= 60, 20, 25 ))))) AS PONTOS_GATTEL
    	  
    FROM FC_FINAL_HIER_VICE t1
    ORDER BY 1,2;

QUIT;


/***JUNTANDO***/


PROC SQL;

CREATE TABLE GAT_TELEFONICO_200 AS
 
   SELECT * FROM GAT_TELEFONICO_25
   OUTER UNION CORR
   SELECT * FROM FC_FINAL_HIER_GEREV_1
   OUTER UNION CORR
   SELECT * FROM FC_FINAL_HIER_SUPER_1
   OUTER UNION CORR
   SELECT * FROM FC_FINAL_HIER_DIR_1
   OUTER UNION CORR
   SELECT * FROM FC_FINAL_HIER_NOVADIR_1
   OUTER UNION CORR
   SELECT * FROM FC_FINAL_HIER_VICE_1
   ;

Quit;



/**GAT TEL 5 MINUTOS**/
/**GAT TEL 5 MINUTOS**/
/**GAT TEL 5 MINUTOS**/
/**GAT TEL 5 MINUTOS**/


/*POR CARTEIRA*/
/*POR CARTEIRA*/


PROC SQL;

   CREATE TABLE GAT_TELEFONICO_5_MINUTOS_TODOS AS SELECT DISTINCT

      t1.PREFIXO,
	  t1.CARTEIRA,
	  t1.PTL,
	  t1.MCI,
	  t1.DATA_ABERTURA_NOVO_ULT,
	  t1.DATA_FECHAMENTO_NOVO_ULT,
	  t1.HMS_ABERTURA_NOVO_ULT,
	  t1.HMS_FECHAMENTO_NOVO_ULT,
	  t1.START
	  
    FROM GAT_TELEFONICO_13_CORRIGIDO t1;

QUIT;


PROC SQL;

   CREATE TABLE GAT_TELEFONICO_5_MINUTOS_TODOS_1 AS SELECT DISTINCT

      t1.PREFIXO,
	  t1.CARTEIRA,	  
	  COUNT(t1.MCI) AS CONT_TODOS  
	  
    FROM GAT_TELEFONICO_5_MINUTOS_TODOS t1
	WHERE t1.CARTEIRA <> 0
    GROUP BY 1,2;

QUIT;


PROC SQL;

   CREATE TABLE GAT_TELEFONICO_5_MINUTOS_CORTE AS SELECT DISTINCT

      t1.PREFIXO,
	  t1.CARTEIRA,
	  t1.PTL,
	  t1.MCI,
	  t1.DATA_ABERTURA_NOVO_ULT,
	  t1.DATA_FECHAMENTO_NOVO_ULT,
	  t1.HMS_ABERTURA_NOVO_ULT,
	  t1.HMS_FECHAMENTO_NOVO_ULT,
	  t1.START
	  
    FROM GAT_TELEFONICO_13_CORRIGIDO t1
    WHERE t1.START <= 20;

QUIT;


PROC SQL;

   CREATE TABLE GAT_TELEFONICO_5_MINUTOS_CORTE_1 AS SELECT DISTINCT

      t1.PREFIXO,
	  t1.CARTEIRA,
	  COUNT(t1.MCI) AS CONT_5MIN  
	  
    FROM GAT_TELEFONICO_5_MINUTOS_CORTE t1
	WHERE t1.CARTEIRA <> 0
    GROUP BY 1,2;

QUIT;


PROC SQL;

   CREATE TABLE GAT_TELEFONICO_5_MINUTOS_FINAL AS SELECT DISTINCT

      t1.PREFIXO,
	  t1.CARTEIRA,
      t1.CONT_TODOS, 
	  t2.CONT_5MIN  
	  
    FROM GAT_TELEFONICO_5_MINUTOS_TODOS_1 t1
	LEFT JOIN GAT_TELEFONICO_5_MINUTOS_CORTE_1 t2 ON t1.PREFIXO = t2.PREFIXO AND t1.CARTEIRA = t2.CARTEIRA
    ;

QUIT;


PROC STDIZE DATA=GAT_TELEFONICO_5_MINUTOS_FINAL OUT=GAT_TELEFONICO_5_MINUTOS_FINAL REPONLY MISSING=0;
	VAR _NUMERIC_;
QUIT;



PROC SQL;

   CREATE TABLE GAT_FINAL_5_MINUTOS_FINAL_1 AS SELECT DISTINCT

      t1.PREFIXO,
	  t1.CARTEIRA,      
	  (t1.CONT_5MIN / t1.CONT_TODOS)*100 FORMAT 32.2 AS PORCENT
	  
    FROM GAT_TELEFONICO_5_MINUTOS_FINAL t1;

QUIT;


DATA GAT_FINAL_5_MINUTOS_FINAL_1;
SET GAT_FINAL_5_MINUTOS_FINAL_1;
TipDepCnx = 1;
run;


PROC SQL;

   CREATE TABLE GAT_FINAL_5_MINUTOS_FINAL_2 AS SELECT DISTINCT

      t1.PREFIXO AS PREFDEP,
	  t1.CARTEIRA AS CTRA,
	  t1.TipDepCnx,
	  t1.PORCENT AS START_5,

      IFN(t1.PORCENT <= 60, 0, IFN(t1.PORCENT <= 70, 5, IFN(t1.PORCENT <= 80, 10, IFN(t1.PORCENT <= 85, 15, IFN(t1.PORCENT <= 90, 20, 25 ))))) AS PONTOS_TEL_5MIN
    	  
    FROM GAT_FINAL_5_MINUTOS_FINAL_1 t1;

QUIT;


/***COLOCANDO A REGUA POR PREFIXO***/
/***COLOCANDO A REGUA POR PREFIXO***/
/***COLOCANDO A REGUA POR PREFIXO***/
/***COLOCANDO A REGUA POR PREFIXO***/


PROC SQL;

   CREATE TABLE T5MIN_SO_PREF AS SELECT

      t1.PREFIXO,      
	  t1.MCI,
	  t1.START
    	  
    FROM GAT_TELEFONICO_13_CORRIGIDO t1
    ORDER BY 1, 2, 3;

QUIT;


PROC SQL;

   CREATE TABLE T5MIN_PAA_PREF AS SELECT

      input(t2.PREFAGENC, 4.) AS PREFIXO,      
	  t1.MCI,
      t1.START
    	  
    FROM GAT_TELEFONICO_13_CORRIGIDO t1
	INNER JOIN IGR.IGRREDE_&ANOMES. t2 ON t1.PREFIXO = input(t2.PREFDEP, 4.)
	INNER JOIN ACORDO_PREFIXO_1 t3 ON input(t2.PREFAGENC, 4.) = t3.PREFIXO
	WHERE input(t2.PREFAGENC, 4.) <> 0
    ORDER BY 1, 2, 3;

QUIT;


PROC SQL;

CREATE TABLE TABELA_5MIN_PREF_FINAL AS

   SELECT * FROM T5MIN_SO_PREF
   OUTER UNION CORR 
   SELECT * FROM T5MIN_PAA_PREF
   
   ;
Quit;


PROC STDIZE DATA=TABELA_5MIN_PREF_FINAL OUT=TABELA_5MIN_PREF_FINAL REPONLY MISSING=0;
	VAR _NUMERIC_;
QUIT;


/*O PAA FOI INCLUIDO*/

PROC SQL;

   CREATE TABLE GAT_TELEFONICO_5_MINUTOS_TODOS AS SELECT

      t1.PREFIXO,
	  t1.MCI,
	  t1.START
	  
    FROM TABELA_5MIN_PREF_FINAL t1;

QUIT;


PROC SQL;

   CREATE TABLE GAT_TELEFONICO_5_MINUTOS_CORTE AS SELECT

      t1.PREFIXO,
	  t1.MCI,
	  t1.START
	  
    FROM TABELA_5MIN_PREF_FINAL t1
    WHERE t1.START <= 20;

QUIT;


PROC SQL;

   CREATE TABLE GAT_TELEFONICO_5_MINUTOS_TODOS_A AS SELECT DISTINCT

      t1.PREFIXO,	  
	  COUNT(t1.MCI) AS CONT_TODOS  
	  
    FROM GAT_TELEFONICO_5_MINUTOS_TODOS t1
	GROUP BY 1;

QUIT;


PROC SQL;

   CREATE TABLE GAT_TELEFONICO_5_MINUTOS_CORTE_A AS SELECT DISTINCT

      t1.PREFIXO,
	  COUNT(t1.MCI) AS CONT_5MIN  
	  
    FROM GAT_TELEFONICO_5_MINUTOS_CORTE t1
	GROUP BY 1;

QUIT;


PROC SQL;

   CREATE TABLE GAT_TELEFONICO_5_MINUTOS_A AS SELECT DISTINCT

      t1.PREFIXO,
	  t1.CONT_TODOS, 
	  t2.CONT_5MIN  
	  
    FROM GAT_TELEFONICO_5_MINUTOS_TODOS_A t1
	LEFT JOIN GAT_TELEFONICO_5_MINUTOS_CORTE_A t2 ON t1.PREFIXO = t2.PREFIXO
    ;

QUIT;


PROC STDIZE DATA=GAT_TELEFONICO_5_MINUTOS_A OUT=GAT_TELEFONICO_5_MINUTOS_A REPONLY MISSING=0;
	VAR _NUMERIC_;
QUIT;


PROC SQL;

   CREATE TABLE GAT_FINAL_5_MINUTOS_FINAL_3 AS SELECT DISTINCT

      t1.PREFIXO,	        
	  SUM(t1.CONT_5MIN) AS CONT_5MIN,
      SUM(t1.CONT_TODOS) AS CONT_TODOS
	  
    FROM GAT_TELEFONICO_5_MINUTOS_A t1
    GROUP BY 1;

QUIT;


PROC SQL;

   CREATE TABLE GAT_FINAL_5_MINUTOS_FINAL_4 AS SELECT DISTINCT

      t1.PREFIXO,	       
	  (t1.CONT_5MIN / t1.CONT_TODOS)*100 FORMAT 32.2 AS PORCENT
	  
    FROM GAT_FINAL_5_MINUTOS_FINAL_3 t1
    GROUP BY 1;

QUIT;


DATA GAT_FINAL_5_MINUTOS_FINAL_4;
SET GAT_FINAL_5_MINUTOS_FINAL_4;
TipDepCnx = 2;
run;


PROC SQL;

   CREATE TABLE GAT_FINAL_5_MINUTOS_FINAL_5 AS SELECT DISTINCT

      t1.PREFIXO AS PREFDEP,
	  0 AS CARTEIRA AS CTRA,
	  t1.TipDepCnx,
	  t1.PORCENT AS START_5,

      IFN(t1.PORCENT <= 60, 0, IFN(t1.PORCENT <= 70, 5, IFN(t1.PORCENT <= 80, 10, IFN(t1.PORCENT <= 85, 15, IFN(t1.PORCENT <= 90, 20, 25 ))))) AS PONTOS_TEL_5MIN
    	  
    FROM GAT_FINAL_5_MINUTOS_FINAL_4 t1;

QUIT;


PROC SQL;

CREATE TABLE GAT_TEL_5_MIN_JUNT AS
 
   SELECT * FROM GAT_FINAL_5_MINUTOS_FINAL_2
   OUTER UNION CORR
   SELECT * FROM GAT_FINAL_5_MINUTOS_FINAL_5
   ;

Quit;


PROC SQL;

   CREATE TABLE GAT_TEL_5_MIN_JUNT_2 AS SELECT DISTINCT *
          	  
   FROM GAT_TEL_5_MIN_JUNT
   ORDER BY 1,2 ;

QUIT;


/***COLOCANDO A REGUA NA HIERARQUIA***/
/***COLOCANDO A REGUA NA HIERARQUIA***/
/***COLOCANDO A REGUA NA HIERARQUIA***/
/***COLOCANDO A REGUA NA HIERARQUIA***/


PROC SQL;

   CREATE TABLE GAT_HIER_5_MINUTOS_TODOS AS SELECT DISTINCT

      t1.PREFIXO,
	  t1.CARTEIRA,
	  t1.PTL,
	  t1.MCI,
	  t1.DATA_ABERTURA_NOVO_ULT,
	  t1.DATA_FECHAMENTO_NOVO_ULT,
	  t1.HMS_ABERTURA_NOVO_ULT,
	  t1.HMS_FECHAMENTO_NOVO_ULT,
	  t1.START
	  
    FROM GAT_TELEFONICO_13_CORRIGIDO t1;

QUIT;


PROC SQL;

   CREATE TABLE GAT_HIER_5_MINUTOS_TODOS_1 AS SELECT DISTINCT

      t1.PREFIXO,	   
	  COUNT(t1.MCI) AS CONT_TODOS  
	  
    FROM GAT_HIER_5_MINUTOS_TODOS t1
	GROUP BY 1;

QUIT;


PROC SQL;

   CREATE TABLE GAT_HIER_5_MINUTOS_CORTE AS SELECT DISTINCT

      t1.PREFIXO,
	  t1.CARTEIRA,
	  t1.PTL,
	  t1.MCI,
	  t1.DATA_ABERTURA_NOVO_ULT,
	  t1.DATA_FECHAMENTO_NOVO_ULT,
	  t1.HMS_ABERTURA_NOVO_ULT,
	  t1.HMS_FECHAMENTO_NOVO_ULT,
	  t1.START
	  
    FROM GAT_TELEFONICO_13_CORRIGIDO t1
    WHERE t1.START <= 20;

QUIT;


PROC SQL;

   CREATE TABLE GAT_HIER_5_MINUTOS_CORTE_1 AS SELECT DISTINCT

      t1.PREFIXO,
	  COUNT(t1.MCI) AS CONT_5MIN  
	  
    FROM GAT_HIER_5_MINUTOS_CORTE t1
	GROUP BY 1;

QUIT;


PROC SQL;

   CREATE TABLE GAT_HIER_5_MINUTOS_FINAL AS SELECT DISTINCT

      t1.PREFIXO,
	  t1.CONT_TODOS, 
	  t2.CONT_5MIN  
	  
    FROM GAT_HIER_5_MINUTOS_TODOS_1 t1
	LEFT JOIN GAT_HIER_5_MINUTOS_CORTE_1 t2 ON t1.PREFIXO = t2.PREFIXO
    ;

QUIT;


PROC STDIZE DATA=GAT_HIER_5_MINUTOS_FINAL OUT=GAT_HIER_5_MINUTOS_FINAL REPONLY MISSING=0;
	VAR _NUMERIC_;
QUIT;


PROC SQL;

   CREATE TABLE FC_FINAL_HIER AS SELECT DISTINCT

      t1.PREFIXO,
      t1.CONT_TODOS, 
	  t1.CONT_5MIN,
	  t2.PREFSUPREG AS GEREV,
	  t2.PREFSUPEST AS SUPER,
	  t2.PREFUEN AS DIR,
	  8592 AS NOVADIR,
	  8166 AS VICE
	  
    FROM GAT_HIER_5_MINUTOS_FINAL t1
    INNER JOIN IGR.IGRREDE_&ANOMES. t2 ON t1.PREFIXO = input(t2.PREFDEP, 4.)
	GROUP BY 1;

QUIT;


/*GEREV*/
/*GEREV*/
/*GEREV*/
/*GEREV*/


PROC SQL;

   CREATE TABLE FC_FINAL_HIER_GEREV AS SELECT DISTINCT

      input(t1.GEREV, 4.) AS PREFDEP,
	  0 AS CTRA,
	  SUM(t1.CONT_TODOS) AS CONT_TODOS, 
	  SUM(t1.CONT_5MIN) AS CONT_5MIN
    	  
    FROM FC_FINAL_HIER t1
    GROUP BY 1;

QUIT;



PROC SQL;

   CREATE TABLE FC_FINAL_HIER_GEREV AS SELECT DISTINCT

      PREFDEP,
	  CTRA,
	  (t1.CONT_5MIN / t1.CONT_TODOS)*100 FORMAT 32.2 AS START_MEDIO
    	  
    FROM FC_FINAL_HIER_GEREV t1
    GROUP BY 1;

QUIT;


DATA FC_FINAL_HIER_GEREV;
SET FC_FINAL_HIER_GEREV;
TipDepCnx = 0;
run;



PROC SQL;

   CREATE TABLE FC_FINAL_HIER_GEREV_1 AS SELECT DISTINCT

      t1.PREFDEP,
	  t1.CTRA,
	  t1.TipDepCnx,
	  t1.START_MEDIO AS START_5,

      IFN(START_MEDIO <= 60, 0, IFN(START_MEDIO <= 70, 5, IFN(START_MEDIO <= 80, 10, IFN(START_MEDIO <= 85, 15, IFN(START_MEDIO <= 90, 20, 25 ))))) AS PONTOS_TEL_5MIN
	      	  
    FROM FC_FINAL_HIER_GEREV t1
    ORDER BY 1,2;

QUIT;


/*SUPER*/
/*SUPER*/
/*SUPER*/
/*SUPER*/


PROC SQL;

   CREATE TABLE FC_FINAL_HIER_SUPER AS SELECT DISTINCT

      input(t1.SUPER, 4.) AS PREFDEP,
	  0 AS CTRA,
	  SUM(t1.CONT_TODOS) AS CONT_TODOS, 
	  SUM(t1.CONT_5MIN) AS CONT_5MIN
    	  
    FROM FC_FINAL_HIER t1
    GROUP BY 1;

QUIT;


PROC SQL;

   CREATE TABLE FC_FINAL_HIER_SUPER AS SELECT DISTINCT

      PREFDEP,
	  CTRA,
	  (t1.CONT_5MIN / t1.CONT_TODOS)*100 FORMAT 32.2 AS START_MEDIO
    	  
    FROM FC_FINAL_HIER_SUPER t1
    GROUP BY 1;

QUIT;


DATA FC_FINAL_HIER_SUPER;
SET FC_FINAL_HIER_SUPER;
TipDepCnx = 0;
run;


PROC SQL;

   CREATE TABLE FC_FINAL_HIER_SUPER_1 AS SELECT DISTINCT

      t1.PREFDEP,
	  t1.CTRA,
	  t1.TipDepCnx,
	  t1.START_MEDIO AS START_5,

      IFN(START_MEDIO <= 60, 0, IFN(START_MEDIO <= 70, 5, IFN(START_MEDIO <= 80, 10, IFN(START_MEDIO <= 85, 15, IFN(START_MEDIO <= 90, 20, 25 ))))) AS PONTOS_TEL_5MIN
    	  
    FROM FC_FINAL_HIER_SUPER t1
    ORDER BY 1,2;

QUIT;


/**DIR**/
/**DIR**/
/**DIR**/
/**DIR**/


PROC SQL;

   CREATE TABLE FC_FINAL_HIER_DIR AS SELECT DISTINCT

      input(t1.DIR, 4.) AS PREFDEP,
	  0 AS CTRA,
	  SUM(t1.CONT_TODOS) AS CONT_TODOS, 
	  SUM(t1.CONT_5MIN) AS CONT_5MIN
    	  
    FROM FC_FINAL_HIER t1
    GROUP BY 1;

QUIT;


PROC SQL;

   CREATE TABLE FC_FINAL_HIER_DIR AS SELECT DISTINCT

      PREFDEP,
	  CTRA,
	  (t1.CONT_5MIN / t1.CONT_TODOS)*100 FORMAT 32.2 AS START_MEDIO
    	  
    FROM FC_FINAL_HIER_DIR t1
    GROUP BY 1;

QUIT;


DATA FC_FINAL_HIER_DIR;
SET FC_FINAL_HIER_DIR;
TipDepCnx = 0;
run;


PROC SQL;

   CREATE TABLE FC_FINAL_HIER_DIR_1 AS SELECT DISTINCT

      t1.PREFDEP,
	  t1.CTRA,
	  t1.TipDepCnx,
	  t1.START_MEDIO AS START_5,

      IFN(START_MEDIO <= 60, 0, IFN(START_MEDIO <= 70, 5, IFN(START_MEDIO <= 80, 10, IFN(START_MEDIO <= 85, 15, IFN(START_MEDIO <= 90, 20, 25 ))))) AS PONTOS_TEL_5MIN
    	  
    FROM FC_FINAL_HIER_DIR t1
    ORDER BY 1,2;

QUIT;


/**NOVADIR**/
/**NOVADIR**/
/**NOVADIR**/
/**NOVADIR**/


PROC SQL;

   CREATE TABLE FC_FINAL_HIER_NOVADIR AS SELECT DISTINCT

      t1.NOVADIR AS PREFDEP,
	  0 AS CTRA,
	  SUM(t1.CONT_TODOS) AS CONT_TODOS, 
	  SUM(t1.CONT_5MIN) AS CONT_5MIN
    	  
    FROM FC_FINAL_HIER t1
    GROUP BY 1;

QUIT;


PROC SQL;

   CREATE TABLE FC_FINAL_HIER_NOVADIR AS SELECT DISTINCT

      PREFDEP,
	  CTRA,
	  (t1.CONT_5MIN / t1.CONT_TODOS)*100 FORMAT 32.2 AS START_MEDIO
    	  
    FROM FC_FINAL_HIER_NOVADIR t1
    GROUP BY 1;

QUIT;


DATA FC_FINAL_HIER_NOVADIR;
SET FC_FINAL_HIER_NOVADIR;
TipDepCnx = 0;
run;


PROC SQL;

   CREATE TABLE FC_FINAL_HIER_NOVADIR_1 AS SELECT DISTINCT

      t1.PREFDEP,
	  t1.CTRA,
	  t1.TipDepCnx,
	  t1.START_MEDIO AS START_5,

      IFN(START_MEDIO <= 60, 0, IFN(START_MEDIO <= 70, 5, IFN(START_MEDIO <= 80, 10, IFN(START_MEDIO <= 85, 15, IFN(START_MEDIO <= 90, 20, 25 ))))) AS PONTOS_TEL_5MIN
    	  
    FROM FC_FINAL_HIER_NOVADIR t1
    ORDER BY 1,2;

QUIT;


/**VICE**/
/**VICE**/
/**VICE**/
/**VICE**/


PROC SQL;

   CREATE TABLE FC_FINAL_HIER_VICE AS SELECT DISTINCT

      t1.VICE AS PREFDEP,
	  0 AS CTRA,
	  SUM(t1.CONT_TODOS) AS CONT_TODOS, 
	  SUM(t1.CONT_5MIN) AS CONT_5MIN
    	  
    FROM FC_FINAL_HIER t1
    GROUP BY 1;

QUIT;


PROC SQL;

   CREATE TABLE FC_FINAL_HIER_VICE AS SELECT DISTINCT

      PREFDEP,
	  CTRA,
	  (t1.CONT_5MIN / t1.CONT_TODOS)*100 FORMAT 32.2 AS START_MEDIO
    	  
    FROM FC_FINAL_HIER_VICE t1
    GROUP BY 1;

QUIT;


DATA FC_FINAL_HIER_VICE;
SET FC_FINAL_HIER_VICE;
TipDepCnx = 0;
run;


PROC SQL;

   CREATE TABLE FC_FINAL_HIER_VICE_1 AS SELECT DISTINCT

      t1.PREFDEP,
	  t1.CTRA,
	  t1.TipDepCnx,
	  t1.START_MEDIO AS START_5,

      IFN(START_MEDIO <= 60, 0, IFN(START_MEDIO <= 70, 5, IFN(START_MEDIO <= 80, 10, IFN(START_MEDIO <= 85, 15, IFN(START_MEDIO <= 90, 20, 25 ))))) AS PONTOS_TEL_5MIN
    	  
    FROM FC_FINAL_HIER_VICE t1
    ORDER BY 1,2;

QUIT;


/***JUNTANDO***/


PROC SQL;

CREATE TABLE GAT_TEL_5_MIN_JUNT_200 AS
 
   SELECT * FROM GAT_TEL_5_MIN_JUNT_2
   OUTER UNION CORR
   SELECT * FROM FC_FINAL_HIER_GEREV_1
   OUTER UNION CORR
   SELECT * FROM FC_FINAL_HIER_SUPER_1
   OUTER UNION CORR
   SELECT * FROM FC_FINAL_HIER_DIR_1
   OUTER UNION CORR
   SELECT * FROM FC_FINAL_HIER_NOVADIR_1
   OUTER UNION CORR
   SELECT * FROM FC_FINAL_HIER_VICE_1
   ;

Quit;


/*ORDENANDO*/
/*ORDENANDO*/


PROC SQL;

   CREATE TABLE FALECOM_200 AS SELECT DISTINCT *
          	  
   FROM FALECOM_200
   ORDER BY 1,2 ;

QUIT;


PROC SQL;

   CREATE TABLE GAT_PRESENCIAL_200 AS SELECT DISTINCT *
          	  
   FROM GAT_PRESENCIAL_200
   ORDER BY 1,2 ;

QUIT;


PROC SQL;

   CREATE TABLE GAT_TELEFONICO_200 AS SELECT DISTINCT *
          	  
   FROM GAT_TELEFONICO_200
   ORDER BY 1,2 ;

QUIT;


PROC SQL;

   CREATE TABLE GAT_TEL_5_MIN_JUNT_200 AS SELECT DISTINCT *
          	  
   FROM GAT_TEL_5_MIN_JUNT_200
   ORDER BY 1,2 ;

QUIT;



/*****************FINALIZANDO*****************/
/*****************FINALIZANDO*****************/
/*****************FINALIZANDO*****************/
/*****************FINALIZANDO*****************/


DATA TABELA_FINAL;
MERGE FALECOM_200 GAT_PRESENCIAL_200 GAT_TELEFONICO_200 GAT_TEL_5_MIN_JUNT_200;
BY PREFDEP CTRA TipDepCnx;
RUN;


PROC SQL;
   CREATE TABLE TABELA_FINAL_1 AS SELECT DISTINCT

      t1.PREFDEP,
	  t1.CTRA AS CARTEIRA,
	  t1.TipDepCnx,
      t1.START_FC FORMAT 32.2,
	  IFN(t1.START_FC IS NOT MISSING, 1, 0) AS AUX_FC,
	  IFN(t1.PONTOS_FALECOM IS MISSING, 0, t1.PONTOS_FALECOM) FORMAT 32.2 AS PONTOS_FALECOM,

      t1.START_PRES FORMAT 32.2,
	  IFN(t1.START_PRES IS NOT MISSING, 1, 0) AS AUX_PRES,
	  IFN(t1.PONTOS_PRES IS MISSING, 0, t1.PONTOS_PRES) FORMAT 32.2 AS PONTOS_PRES,
	  
      t1.START_TEL FORMAT 32.2,
	  IFN(t1.START_TEL IS NOT MISSING, 1, 0) AS AUX_TEL,
	  IFN(t1.PONTOS_GATTEL IS MISSING, 0, t1.PONTOS_GATTEL) FORMAT 32.2 AS PONTOS_GATTEL,
	 
      t1.START_5 FORMAT 32.2,
	  IFN(t1.START_5 IS NOT MISSING, 1, 0) AS AUX_5MIN,
	  IFN(t1.PONTOS_TEL_5MIN IS MISSING, 0, t1.PONTOS_TEL_5MIN) FORMAT 32.2 AS PONTOS_TEL_5MIN
	  
      FROM TABELA_FINAL t1;

QUIT;


PROC SQL;

   CREATE TABLE TABELA_FINAL_2 AS SELECT DISTINCT

      t1.PREFDEP,
	  t1.CARTEIRA,
	  t1.TipDepCnx,

      t1.START_FC FORMAT 32.2,
	  t1.PONTOS_FALECOM FORMAT 32.2,
	  
      t1.START_PRES FORMAT 32.2,
	  t1.PONTOS_PRES FORMAT 32.2,
	  
      t1.START_TEL FORMAT 32.2,
	  t1.PONTOS_GATTEL FORMAT 32.2,
	  
      t1.START_5 FORMAT 32.2,
	  t1.PONTOS_TEL_5MIN FORMAT 32.2,

	  (t1.AUX_FC + t1.AUX_PRES + t1.AUX_TEL + t1.AUX_5MIN) AS AUX,

	  (t1.PONTOS_FALECOM + t1.PONTOS_PRES + t1.PONTOS_GATTEL + t1.PONTOS_TEL_5MIN) AS PONTOS

      FROM TABELA_FINAL_1 t1;

QUIT;



PROC SQL;

   CREATE TABLE TABELA_FINAL_3 AS SELECT DISTINCT

      t1.PREFDEP,
	  t1.CARTEIRA,
	  t1.TipDepCnx,

      t1.START_FC FORMAT 32.2,
	  IFN(t1.START_FC IS NOT MISSING, (t1.PONTOS_FALECOM*4)/t1.AUX, 0) FORMAT 32.2 AS PONTOS_FALECOM,

      t1.START_PRES FORMAT 32.2,
	  IFN(t1.START_PRES IS NOT MISSING, (t1.PONTOS_PRES*4)/t1.AUX, 0) FORMAT 32.2 AS PONTOS_PRES,

      t1.START_TEL FORMAT 32.2,
	  IFN(t1.START_TEL IS NOT MISSING, (t1.PONTOS_GATTEL*4)/t1.AUX, 0) FORMAT 32.2 AS PONTOS_GATTEL,

      t1.START_5 FORMAT 32.2,
	  IFN(t1.START_5 IS NOT MISSING, (t1.PONTOS_TEL_5MIN*4)/t1.AUX, 0) FORMAT 32.2 AS PONTOS_TEL_5MIN,

	  /*t1.AUX,*/
	  t1.PONTOS,

	  IFN(t1.AUX = 1, (100/25)*t1.PONTOS, IFN(t1.AUX = 2, (100/50)*t1.PONTOS, IFN(t1.AUX = 3, (100/75)*t1.PONTOS, t1.PONTOS))) FORMAT 32.2 AS REALIZADO

      FROM TABELA_FINAL_2 t1;

QUIT;


PROC STDIZE DATA=TABELA_FINAL_3 OUT=TABELA_FINAL_3 REPONLY MISSING=0;
	VAR _NUMERIC_;
QUIT;


PROC SQL;

   CREATE TABLE LEVANTAMENTO_TOTAL AS SELECT DISTINCT

      t1.PREFDEP,
	  t1.CARTEIRA,

      t1.START_FC FORMAT 32.2 AS DIFERENCA_FC,
	  t1.PONTOS_FALECOM FORMAT 32.2,

      t1.START_PRES FORMAT 32.2 AS DIFERENCA_PRES,
	  t1.PONTOS_PRES FORMAT 32.2,

      t1.START_TEL FORMAT 32.2 AS DIFERENCA_TEL,
	  t1.PONTOS_GATTEL FORMAT 32.2 AS PONTOS_TEL,

      t1.START_5 FORMAT 32.2 AS DIFERENCA_TEL_5M,
	  t1.PONTOS_TEL_5MIN FORMAT 32.2 AS PONTOS_TEL_5M,

	  t1.PONTOS,
	  t1.REALIZADO

    FROM TABELA_FINAL_3 t1

    WHERE PREFDEP IN (1236, 324, 4267, 526, 1881, 2707);

QUIT;


PROC SQL;

   CREATE TABLE TABELA_FINAL_4 AS SELECT DISTINCT

      t1.PREFDEP,
	  t1.CARTEIRA,
	  t1.TipDepCnx, 
	  t1.REALIZADO

      FROM TABELA_FINAL_3 t1;

QUIT;


/*TRAZENDO O TipDepCnx*/
/*TRAZENDO O TipDepCnx*/
/*TRAZENDO O TipDepCnx*/
/*TRAZENDO O TipDepCnx*/


PROC SQL;
CREATE TABLE TABELA_FINAL_11 AS SELECT t1.PREFDEP, t1.CARTEIRA, t1.TipDepCnx, t1.REALIZADO, INPUT(t2.TD_SINERGIA, d4.) AS TD_SINERGIA
FROM TABELA_FINAL_4 t1
INNER JOIN IGR.IGRREDE_&ANOMES. t2 ON t1.PREFDEP = INPUT(t2.PREFDEP, d4.)
GROUP BY 1,2;
QUIT;


PROC SQL;
CREATE TABLE TABELA_FINAL_12 AS SELECT t1.PREFDEP, t1.CARTEIRA, IFN(t1.CARTEIRA = 0, t1.TD_SINERGIA, t1.TipDepCnx) AS TipDepCnx , t1.REALIZADO
FROM TABELA_FINAL_11 t1
GROUP BY 1,2;
QUIT;


/*PARA O CONEXO*/
/*PARA O CONEXO*/
/*PARA O CONEXO*/
/*PARA O CONEXO*/


PROC SQL;
    CREATE TABLE CONEXAO AS
        SELECT
            '2000153'
            ||"&Tx_Fon"
            ||REPEAT(' ',45)
            ||COMPRESS(PUT(t1.PrefDep,Z4.))
            ||COMPRESS(PUT(t1.Carteira,Z5.))
            ||"&ANOMES"
            ||put(t1.TipDepCnx,z4.)
            ||'+'
            ||PUT(ABS(t1.REALIZADO)*100,z13.)
            ||'F7176219'
            ||COMPRESS(PUT(Today(), ddmmyy10.))
            ||'N' AS L
        FROM TABELA_FINAL_12 t1       
;QUIT;


%GerarBBM(TabelaSAS=CONEXAO, Caminho=/dados/infor/transfer/enviar/, ExtencaoBBM=M6162);


/*SUBINDO PARA O CONEXAO - FIM*/

x chmod 2777 *;


/*********************RELATORIO**************************/
/*********************RELATORIO**************************/
/*********************RELATORIO**************************/
/*********************RELATORIO**************************/


PROC SQL;

   CREATE TABLE FALECOM_CLIENTES AS SELECT DISTINCT

      t1.PREFIXO,
	  t1.CARTEIRA,
	  t1.MCI,
      t1.DATA_ABERTURA,
	  t1.DATA_FECHAMENTO,
	  t1.HMS_ABERTURA,
	  t1.HMS_FECHAMENTO,
	  t1.DATA_ABERTURA_NOVO_ULT,
	  t1.DATA_FECHAMENTO_NOVO_ULT,
	  t1.HMS_ABERTURA_NOVO_ULT,
	  t1.HMS_FECHAMENTO_NOVO_ULT,
	  t1.START
	  
    FROM FALECOM_9 t1;

QUIT;


PROC SQL;

   CREATE TABLE FALECOM_CLIENTES_PAA AS SELECT DISTINCT

      input(t2.PREFAGENC, 4.) AS PREFIXO,      
	  t1.CARTEIRA,
	  t1.MCI,
      t1.DATA_ABERTURA,
	  t1.DATA_FECHAMENTO,
	  t1.HMS_ABERTURA,
	  t1.HMS_FECHAMENTO,
	  t1.DATA_ABERTURA_NOVO_ULT,
	  t1.DATA_FECHAMENTO_NOVO_ULT,
	  t1.HMS_ABERTURA_NOVO_ULT,
	  t1.HMS_FECHAMENTO_NOVO_ULT,
	  t1.START
    	  
    FROM FALECOM_CLIENTES t1
	INNER JOIN IGR.IGRREDE_&ANOMES. t2 ON t1.PREFIXO = input(t2.PREFDEP, 4.)
	INNER JOIN ACORDO_PREFIXO_1 t3 ON input(t2.PREFAGENC, 4.) = t3.PREFIXO
	WHERE input(t2.PREFAGENC, 4.) <> 0
    ORDER BY 1, 2, 3;

QUIT;


PROC SQL;

CREATE TABLE FALECOM_CLIENTES AS

   SELECT * FROM FALECOM_CLIENTES
   OUTER UNION CORR 
   SELECT * FROM FALECOM_CLIENTES_PAA
   
   ;
Quit;



PROC SQL;

   CREATE TABLE FALECOM_CLIENTES_1 AS SELECT DISTINCT

      t1.PREFIXO AS PREFDEP,
	  t1.CARTEIRA AS CTRA,
	  t1.MCI,
	  COUNT(t1.START) AS CONT_FC,
	  AVG(t1.START) AS MEDIA_FC FORMAT 32.2
	  
    FROM FALECOM_CLIENTES t1
    GROUP BY 1, 2, 3
    ORDER BY 1, 2, 3, 4, 5;

QUIT;


/**/


PROC SQL;

   CREATE TABLE PRESENCIAL_CLIENTES AS SELECT DISTINCT

      t1.PREFIXO,
	  t1.CARTEIRA,
	  t1.MCI,
	  t1.DATA_ABERTURA,
	  t1.DATA_FECHAMENTO,
	  t1.HMS_ABERTURA,
	  t1.HMS_FECHAMENTO,
	  t1.DATA_ABERTURA_NOVO_ULT,
	  t1.DATA_FECHAMENTO_NOVO_ULT,
	  t1.HMS_ABERTURA_NOVO_ULT,
	  t1.HMS_FECHAMENTO_NOVO_ULT,
	  t1.DIFERENCA as START	  
	  
    FROM  GAT_PRESENCIAL_4 t1;

QUIT;


PROC SQL;

   CREATE TABLE PRESENCIAL_CLIENTES_PAA AS SELECT DISTINCT

      input(t2.PREFAGENC, 4.) AS PREFIXO,      
	  t1.CARTEIRA,
	  t1.MCI,
      t1.DATA_ABERTURA,
	  t1.DATA_FECHAMENTO,
	  t1.HMS_ABERTURA,
	  t1.HMS_FECHAMENTO,
	  t1.DATA_ABERTURA_NOVO_ULT,
	  t1.DATA_FECHAMENTO_NOVO_ULT,
	  t1.HMS_ABERTURA_NOVO_ULT,
	  t1.HMS_FECHAMENTO_NOVO_ULT,
	  t1.START
    	  
    FROM PRESENCIAL_CLIENTES t1
	INNER JOIN IGR.IGRREDE_&ANOMES. t2 ON t1.PREFIXO = input(t2.PREFDEP, 4.)
	INNER JOIN ACORDO_PREFIXO_1 t3 ON input(t2.PREFAGENC, 4.) = t3.PREFIXO
	WHERE input(t2.PREFAGENC, 4.) <> 0
    ORDER BY 1, 2, 3;

QUIT;


PROC SQL;

CREATE TABLE PRESENCIAL_CLIENTES AS

   SELECT * FROM PRESENCIAL_CLIENTES
   OUTER UNION CORR 
   SELECT * FROM PRESENCIAL_CLIENTES_PAA
   
   ;
Quit;



PROC SQL;

   CREATE TABLE PRESENCIAL_CLIENTES_1 AS SELECT DISTINCT

      t1.PREFIXO AS PREFDEP,
	  t1.CARTEIRA AS CTRA,
	  t1.MCI,
	  COUNT(t1.START) AS CONT_PRES,
	  AVG(t1.START) AS MEDIA_PRES FORMAT 32.2
	  	  
    FROM PRESENCIAL_CLIENTES t1
    GROUP BY 1, 2, 3
    ORDER BY 1, 2, 3, 4, 5;

QUIT;


/**/


PROC SQL;

   CREATE TABLE TELEFONIA_CLIENTES AS SELECT DISTINCT

      t1.PREFIXO,
	  t1.CARTEIRA,
	  t1.MCI,
	  t1.DATA_ABERTURA,
	  t1.DATA_FECHAMENTO,
	  t1.HMS_ABERTURA,
	  t1.HMS_FECHAMENTO,
	  t1.DATA_ABERTURA_NOVO_ULT,
	  t1.DATA_FECHAMENTO_NOVO_ULT,
	  t1.HMS_ABERTURA_NOVO_ULT,
	  t1.HMS_FECHAMENTO_NOVO_ULT,
	  t1.START	  
	  
    FROM GAT_TELEFONICO_13_CORRIGIDO t1
    GROUP BY 1, 2, 3
    ORDER BY 1, 2, 3 ;

QUIT;


PROC SQL;

   CREATE TABLE TELEFONIA_CLIENTES_PAA AS SELECT DISTINCT

      input(t2.PREFAGENC, 4.) AS PREFIXO,      
	  t1.CARTEIRA,
	  t1.MCI,
      t1.DATA_ABERTURA,
	  t1.DATA_FECHAMENTO,
	  t1.HMS_ABERTURA,
	  t1.HMS_FECHAMENTO,
	  t1.DATA_ABERTURA_NOVO_ULT,
	  t1.DATA_FECHAMENTO_NOVO_ULT,
	  t1.HMS_ABERTURA_NOVO_ULT,
	  t1.HMS_FECHAMENTO_NOVO_ULT,
	  t1.START
    	  
    FROM TELEFONIA_CLIENTES t1
	INNER JOIN IGR.IGRREDE_&ANOMES. t2 ON t1.PREFIXO = input(t2.PREFDEP, 4.)
	INNER JOIN ACORDO_PREFIXO_1 t3 ON input(t2.PREFAGENC, 4.) = t3.PREFIXO
	WHERE input(t2.PREFAGENC, 4.) <> 0
    ORDER BY 1, 2, 3;

QUIT;


PROC SQL;

CREATE TABLE TELEFONIA_CLIENTES AS

   SELECT * FROM TELEFONIA_CLIENTES
   OUTER UNION CORR 
   SELECT * FROM TELEFONIA_CLIENTES_PAA
   
   ;
Quit;



PROC SQL;

   CREATE TABLE TELEFONIA_CLIENTES_1 AS SELECT DISTINCT

      t1.PREFIXO AS PREFDEP,
	  t1.CARTEIRA AS CTRA,
	  t1.MCI,
	  COUNT(t1.START) AS CONT_TEL,
	  AVG(t1.START) AS MEDIA_TEL FORMAT 32.2	  
	  
    FROM TELEFONIA_CLIENTES t1
    GROUP BY 1, 2, 3
    ORDER BY 1, 2, 3, 4, 5;

QUIT;


/**/


PROC SQL;
   CREATE TABLE TEL_5MIN_CLIENTES_1 AS SELECT DISTINCT

      t1.PREFIXO,
	  t1.CARTEIRA,
	  t1.MCI,
	  t1.START,
	  IFN(t1.START<= 20, 1, 0) AS CONT_5       
	  
    FROM TELEFONIA_CLIENTES t1
    ORDER BY 1, 2, 3;

QUIT;


PROC SQL;

   CREATE TABLE TEL_5MIN_CLIENTES_2 AS SELECT DISTINCT

      t1.PREFIXO AS PREFDEP,
	  t1.CARTEIRA AS CTRA,
	  t1.MCI,
	  COUNT(t1.START) AS CONT_TUDO_5,
	  SUM(t1.CONT_5) AS CONT_5	  
	  
    FROM TEL_5MIN_CLIENTES_1 t1
    GROUP BY 1, 2, 3
    ORDER BY 1, 2, 3, 4, 5;

QUIT;


/******************/
/******************/
/******************/
/******************/


DATA CLIENTES_TOTAIS_2;
MERGE FALECOM_CLIENTES_1 PRESENCIAL_CLIENTES_1 TELEFONIA_CLIENTES_1 TEL_5MIN_CLIENTES_2;
BY PREFDEP CTRA MCI ;
RUN;


PROC STDIZE DATA=CLIENTES_TOTAIS_2 OUT=CLIENTES_TOTAIS_2 REPONLY MISSING=0;
	VAR _NUMERIC_;
QUIT;


PROC SQL;

   CREATE TABLE CLIENTES_TOTAIS_2 AS SELECT DISTINCT

      PREFDEP,
	  IFN(CTRA=0, 7002, CTRA) AS CTRA,
	  MCI,
	  CONT_FC,
	  MEDIA_FC*60 FORMAT 32. AS MEDIA_FC,
	  CONT_PRES,
	  MEDIA_PRES*60 FORMAT 32. AS MEDIA_PRES,
	  CONT_TEL,
	  MEDIA_TEL*60 FORMAT 32. AS MEDIA_TEL,
	  CONT_TUDO_5,
	  CONT_5
	  
    FROM CLIENTES_TOTAIS_2 t1
    
    ORDER BY 1, 2, 3;

QUIT;


PROC SQL;

   CREATE TABLE CLIENTES_TOTAIS_2 AS SELECT DISTINCT

      PREFDEP,
	  CTRA,
	  MCI,
	  CONT_FC,
	  MEDIA_FC FORMAT=TIME8. AS MEDIA_FC,
	  CONT_PRES,
	  MEDIA_PRES FORMAT=TIME8. AS MEDIA_PRES,
	  CONT_TEL,
	  MEDIA_TEL FORMAT=TIME8. AS MEDIA_TEL,
	  CONT_TUDO_5,
	  CONT_5
	  
    FROM CLIENTES_TOTAIS_2 t1
    
    ORDER BY 1, 2, 3;

QUIT;



PROC SQL;

   CREATE TABLE CLIENTES_TOTAIS_2 AS SELECT DISTINCT

      PREFDEP,
	  CTRA,
	  MCI,
	  CONT_FC,
	  	  
	  CONT_PRES,	  
	  
	  CONT_TEL,
	  	  
	  CONT_TUDO_5,
	  CONT_5,
	  PUT(t1.MEDIA_FC, TIME8.) AS MEDIA_FC,
	  PUT(t1.MEDIA_PRES, TIME8.) AS MEDIA_PRES,
	  PUT(t1.MEDIA_TEL, TIME8.) AS MEDIA_TEL
	  
    FROM CLIENTES_TOTAIS_2 t1
    
    ORDER BY 1, 2, 3;

QUIT;



/******************/
/******************/
/******************/
/******************/

PROC SQL;

   CREATE TABLE TABELA_FINAL_500_ANT_1 AS SELECT DISTINCT

      t1.PREFDEP,
	  t1.CARTEIRA as CTRA,
	  
      t1.START_FC*60 FORMAT 32. AS START_FC,
	  t1.PONTOS_FALECOM,

      t1.START_PRES*60 FORMAT 32. AS START_PRES,
	  t1.PONTOS_PRES,

      t1.START_TEL*60 FORMAT 32. AS START_TEL,
	  t1.PONTOS_GATTEL,

      t1.START_5*60 FORMAT 32. AS START_5,
	  t1.PONTOS_TEL_5MIN,

	  t1.PONTOS,

	  REALIZADO

      FROM TABELA_FINAL_3 t1;

QUIT;


PROC SQL;

   CREATE TABLE TABELA_FINAL_500_ANT_2 AS SELECT DISTINCT

      t1.PREFDEP,
	  t1.CTRA,
	  
	  t1.START_FC FORMAT=TIME8. AS START_FC,
	  t1.PONTOS_FALECOM,

	  t1.START_PRES FORMAT=TIME8. AS START_PRES,
	  t1.PONTOS_PRES,

	  t1.START_TEL FORMAT=TIME8. AS START_TEL,
	  t1.PONTOS_GATTEL,

      t1.PONTOS_TEL_5MIN,

	  t1.PONTOS,

	  t1.REALIZADO,

	  t1.START_5 FORMAT=TIME8. AS START_5

      FROM TABELA_FINAL_500_ANT_1 t1;

QUIT;


PROC SQL;

   CREATE TABLE TABELA_FINAL_500 AS SELECT DISTINCT

      t1.PREFDEP,
	  t1.CTRA,	  	  
	  t1.PONTOS_FALECOM,	  
	  t1.PONTOS_PRES,
	  t1.PONTOS_GATTEL,
      t1.PONTOS_TEL_5MIN,
	  t1.PONTOS,
	  t1.REALIZADO,

	  PUT(t1.START_5, TIME8.) AS START_5,
	  PUT(t1.START_FC, TIME8.) AS START_FC,
	  PUT(t1.START_PRES, TIME8.) AS START_PRES,
	  PUT(t1.START_TEL, TIME8.) AS START_TEL

      FROM TABELA_FINAL_500_ANT_2 t1;

QUIT;


data TABELA_FINAL_500;
format posicao yymmdd10.;
set TABELA_FINAL_500;
POSICAO = &D1;
run;


/*RELATORIO 585*/
/*RELATORIO*/
/*RELATORIO*/
/*RELATORIO*/


%LET Usuario=f7176219;
%LET Keypass=tempo-resposta-pf-GZZY4c8pdsALyKYYOhnFFsyhzuPSWGUSm50sj9wrLeMlWLYKKc;
%LET Rotina=tempo-resposta-pf;
%ProcessoIniciar();


PROC SQL;
	DROP TABLE TABELAS_EXPORTAR_REL;
	CREATE TABLE TABELAS_EXPORTAR_REL (TABELA_SAS CHAR(100), ROTINA CHAR(100));
	INSERT INTO TABELAS_EXPORTAR_REL VALUES('TABELA_FINAL_500', 'tempo-resposta-pf');
	INSERT INTO TABELAS_EXPORTAR_REL VALUES('CLIENTES_TOTAIS_2', 'detalhe');
   ;
QUIT;


%ProcessoCarregarEncerrar(TABELAS_EXPORTAR_REL);
 
 x cd /dados/infor/producao/Tempo_Resposta_PF_PJ;
 x cd /dados/externo/UNC/GAT/TELEFONE;

 x chmod 2777 *;
